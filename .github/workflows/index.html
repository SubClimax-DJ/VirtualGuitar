<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Guitar Neck V3 - Max Prebeg</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Monoton&family=Inter:wght@400;600&family=Roboto+Slab:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- THEME VARIABLES --- */
        /* Defines color palettes, fonts, and styles for different themes */
        :root {
            /* Default: Psychedelic Theme Variables */
            --bg-gradient: linear-gradient(135deg, #ff00ff, #ff6600, #ffff00, #33ff33, #00ffff, #8a2be2);
            --bg-animation: gradientShift 15s ease infinite;
            --title-font: 'Monoton', cursive;
            --title-color: #ffffff;
            --title-shadow: 2px 2px 4px #000, -2px -2px 4px #f0f, 2px -2px 4px #0ff, -2px 2px 4px #ff0;
            --controls-bg: rgba(138, 43, 226, 0.8); /* Violet */
            --controls-border: #00ffff; /* Cyan */
            --controls-shadow: 0 0 15px 3px rgba(0, 255, 255, 0.5); /* Cyan glow */
            --controls-title-font: 'Monoton', cursive;
            --controls-title-color: #ffff00; /* Yellow */
            --controls-title-shadow: 1px 1px 2px #ff00ff;
            --label-color: #00ffff; /* Cyan */
            --label-shadow: 1px 1px 1px #8a2be2;
            --select-bg: rgba(0,0,0,0.5);
            --select-text: #ffff00; /* Yellow */
            --select-border: #ff00ff; /* Magenta */
            --select-focus-shadow: 0 0 8px #ff00ff;
            --select-arrow-fill: #ffff00;
            --button-bg: linear-gradient(45deg, #ff00ff, #ff6600);
            --button-text: white;
            --button-border: #ffff00;
            --button-hover-shadow: 0 0 10px #ffff00;
            --button-active-bg: linear-gradient(45deg, #33ff33, #00ffff);
            --button-active-text: #1f2937;
            --button-active-border: #ffffff;
            --button-active-shadow: 0 0 10px #00ffff;
            --clear-button-bg: linear-gradient(45deg, #888, #ccc);
            --clear-button-text: #333;
            --clear-button-border: #fff;
            --clear-button-hover-shadow: 0 0 10px #fff;
            --neck-container-bg: #8a2be2; /* Deep Purple */
            --neck-container-border: #ffffff;
            --neck-container-shadow: 0 0 20px 5px rgba(255, 255, 255, 0.5), inset 0 0 10px 2px rgba(0, 0, 0, 0.4);
            --string-color: #00ffff; /* Cyan */
            --string-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff;
            --string-lowE-color: #33ff33; /* Lime */
            --string-lowE-shadow: 0 0 5px #33ff33, 0 0 10px #33ff33;
            --string-A-color: #ffff00; /* Yellow */
            --string-A-shadow: 0 0 5px #ffff00, 0 0 10px #ffff00;
            --string-D-color: #ff6600; /* Orange */
            --string-D-shadow: 0 0 5px #ff6600, 0 0 10px #ff6600;
            --open-marker-border: #ffff00; /* Yellow */
            --open-marker-border-style: dashed;
            --open-marker-bg: rgba(255, 0, 255, 0.2); /* Magenta */
            --open-marker-hover-bg: rgba(255, 0, 255, 0.4);
            --fret-line-bg: linear-gradient(to bottom, #ff00ff, #00ffff);
            --fret-line-shadow: 0 0 3px #ffffff;
            --fret-line-skew: skewX(-5deg);
            --nut-bg: #ffffff;
            --nut-shadow: 0 0 8px #ffffff;
            --fret-dot-bg: #ff6600; /* Orange */
            --fret-dot-border: white;
            --fret-dot-shadow: 0 0 5px #ff6600;
            --fret-dot-double-bg: #33ff33; /* Lime */
            --fret-dot-double-shadow: 0 0 5px #33ff33;
            --fret-number-font: 'Monoton', cursive;
            --fret-number-color: #ffff00;
            --fret-number-shadow: 1px 1px 1px #8a2be2;
            --note-display-bg: rgba(0, 0, 0, 0.6);
            --note-display-border: #ff00ff; /* Magenta */
            --note-display-shadow: 0 0 15px #ff00ff;
            --note-display-text: #33ff33; /* Lime */
            --note-display-text-shadow: 0 0 5px #33ff33;
            --clicked-marker-bg: rgba(0, 255, 255, 0.7); /* Cyan */
            --clicked-marker-border: #ffffff;
            --clicked-marker-shadow: 0 0 10px #00ffff;
            --scale-highlight-shadow: inset 0 0 0 3px #ffff00, 0 0 5px #ffff00; /* Yellow */
            --footer-font: 'Monoton', cursive;
            --footer-color: #ffffff;
            --footer-shadow: 1px 1px 2px #000, -1px -1px 2px #8a2be2, 1px -1px 2px #0ff;
            --clock-font: 'Orbitron', sans-serif;
            --clock-color: #ffffff;
            --clock-shadow: var(--footer-shadow);
            --play-button-bg: rgba(255, 255, 255, 0.1);
            --play-button-border: var(--controls-title-color);
            --play-button-hover-bg: rgba(255, 255, 255, 0.2);
            --play-button-icon-color: var(--controls-title-color);
            --play-button-icon-hover-color: var(--label-color);
        }
        body.theme-acoustic { /* Acoustic Theme Variables */
            --bg-gradient: linear-gradient(to bottom, #a16207, #422006); --bg-animation: none; --title-font: 'Roboto Slab', serif; --title-color: #fef3c7; --title-shadow: 2px 2px 4px rgba(0,0,0,0.6); --controls-bg: rgba(120, 53, 15, 0.8); --controls-border: #fcd34d; --controls-shadow: 0 0 10px 2px rgba(252, 211, 77, 0.4); --controls-title-font: 'Roboto Slab', serif; --controls-title-color: #fef3c7; --controls-title-shadow: 1px 1px 2px rgba(0,0,0,0.5); --label-color: #fcd34d; --label-shadow: 1px 1px 1px rgba(0,0,0,0.4); --select-bg: rgba(66, 32, 6, 0.7); --select-text: #fef3c7; --select-border: #fcd34d; --select-focus-shadow: 0 0 8px #fcd34d; --select-arrow-fill: #fcd34d; --button-bg: linear-gradient(45deg, #d97706, #92400e); --button-text: #ffffff; --button-border: #fef3c7; --button-hover-shadow: 0 0 10px #fcd34d; --button-active-bg: linear-gradient(45deg, #fcd34d, #fbbf24); --button-active-text: #422006; --button-active-border: #ffffff; --button-active-shadow: 0 0 10px #fbbf24; --neck-container-bg: #b45309; --neck-container-border: #fde68a; --neck-container-shadow: 0 6px 12px rgba(0,0,0,0.4), inset 0 0 8px 1px rgba(0, 0, 0, 0.3); --string-color: #e5e7eb; --string-shadow: none; --string-lowE-color: #d1d5db; --string-lowE-shadow: none; --string-A-color: #d1d5db; --string-A-shadow: none; --string-D-color: #e5e7eb; --string-D-shadow: none; --open-marker-border: #9ca3af; --open-marker-border-style: solid; --open-marker-bg: rgba(255, 255, 255, 0.1); --open-marker-hover-bg: rgba(255, 255, 255, 0.2); --fret-line-bg: #a8a29e; --fret-line-shadow: none; --fret-line-skew: none; --nut-bg: #e5e7eb; --nut-shadow: none; --fret-dot-bg: #4b5563; --fret-dot-border: #9ca3af; --fret-dot-shadow: inset 0 0 2px rgba(255,255,255,0.5); --fret-dot-double-bg: #4b5563; --fret-dot-double-shadow: inset 0 0 2px rgba(255,255,255,0.5); --fret-number-font: 'Roboto Slab', serif; --fret-number-color: #fef3c7; --fret-number-shadow: 1px 1px 1px rgba(0,0,0,0.4); --note-display-bg: rgba(66, 32, 6, 0.85); --note-display-border: #fcd34d; --note-display-shadow: 0 0 10px rgba(252, 211, 77, 0.3); --note-display-text: #fef9c3; --note-display-text-shadow: 1px 1px 2px rgba(0,0,0,0.5); --clicked-marker-bg: rgba(251, 191, 36, 0.6); --clicked-marker-border: #fef3c7; --clicked-marker-shadow: 0 0 8px #fbbf24; --scale-highlight-shadow: inset 0 0 0 3px #fcd34d, 0 0 5px #fcd34d; --footer-font: 'Roboto Slab', serif; --footer-color: #fef3c7; --footer-shadow: 1px 1px 2px rgba(0,0,0,0.6); --clock-font: 'Orbitron', sans-serif; --clock-color: var(--footer-color); --clock-shadow: var(--footer-shadow); --play-button-bg: rgba(254, 243, 199, 0.15); --play-button-border: #fcd34d; --play-button-hover-bg: rgba(254, 243, 199, 0.25); --play-button-icon-color: #fcd34d; --play-button-icon-hover-color: #fef3c7;
        }
        body.theme-modern { /* Modern Theme Variables */
            --bg-gradient: linear-gradient(to bottom, #1f2937, #374151); --bg-animation: none; --title-font: 'Inter', sans-serif; --title-color: #e5e7eb; --title-shadow: none; --controls-bg: rgba(55, 65, 81, 0.85); --controls-border: #6b7280; --controls-shadow: 0 4px 8px rgba(0,0,0,0.3); --controls-title-font: 'Inter', sans-serif; --controls-title-color: #e5e7eb; --controls-title-shadow: none; --label-color: #d1d5db; --label-shadow: none; --select-bg: rgba(31, 41, 55, 0.8); --select-text: #e5e7eb; --select-border: #4b5563; --select-focus-shadow: 0 0 0 2px #60a5fa; --select-arrow-fill: #9ca3af; --button-bg: linear-gradient(45deg, #3b82f6, #2563eb); --button-text: white; --button-border: #60a5fa; --button-hover-shadow: 0 0 8px rgba(96, 165, 250, 0.5); --button-active-bg: linear-gradient(45deg, #60a5fa, #93c5fd); --button-active-text: #1f2937; --button-active-border: #ffffff; --button-active-shadow: 0 0 8px #93c5fd; --clear-button-bg: linear-gradient(45deg, #6b7280, #9ca3af); --clear-button-text: #1f2937; --clear-button-border: #d1d5db; --clear-button-hover-shadow: 0 0 8px #9ca3af; --neck-container-bg: #4b5563; --neck-container-border: #9ca3af; --neck-container-shadow: 0 6px 12px rgba(0,0,0,0.3), inset 0 0 5px rgba(0,0,0,0.2); --string-color: #9ca3af; --string-shadow: none; --string-lowE-color: #6b7280; --string-lowE-shadow: none; --string-A-color: #6b7280; --string-A-shadow: none; --string-D-color: #9ca3af; --string-D-shadow: none; --open-marker-border: #6b7280; --open-marker-border-style: solid; --open-marker-bg: rgba(255, 255, 255, 0.05); --open-marker-hover-bg: rgba(255, 255, 255, 0.1); --fret-line-bg: #9ca3af; --fret-line-shadow: none; --fret-line-skew: none; --nut-bg: #d1d5db; --nut-shadow: none; --fret-dot-bg: #d1d5db; --fret-dot-border: #6b7280; --fret-dot-shadow: none; --fret-dot-double-bg: #d1d5db; --fret-dot-double-shadow: none; --fret-number-font: 'Inter', sans-serif; --fret-number-color: #9ca3af; --fret-number-shadow: none; --note-display-bg: rgba(31, 41, 55, 0.9); --note-display-border: #6b7280; --note-display-shadow: 0 4px 8px rgba(0,0,0,0.2); --note-display-text: #93c5fd; --note-display-text-shadow: none; --clicked-marker-bg: rgba(96, 165, 250, 0.7); --clicked-marker-border: #dbeafe; --clicked-marker-shadow: 0 0 8px #60a5fa; --scale-highlight-shadow: inset 0 0 0 3px #60a5fa, 0 0 5px #60a5fa; --footer-font: 'Inter', sans-serif; --footer-color: #9ca3af; --footer-shadow: none; --clock-font: 'Orbitron', sans-serif; --clock-color: var(--footer-color); --clock-shadow: var(--footer-shadow); --play-button-bg: rgba(219, 234, 254, 0.1); --play-button-border: #60a5fa; --play-button-hover-bg: rgba(219, 234, 254, 0.2); --play-button-icon-color: #60a5fa; --play-button-icon-hover-color: #93c5fd;
        }

        /* --- BASE STYLES USING VARIABLES --- */
        html, body { height: 100%; margin: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            background-size: 400% 400%;
            animation: var(--bg-animation);
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; padding: 1rem; overflow-x: hidden;
        }
        @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* Main Layout - Side Panel */
        .main-container {
            display: flex; flex-direction: row; justify-content: center; align-items: flex-start;
            gap: 1.5rem; width: 100%; max-width: 1400px; margin-top: 1rem;
        }
        /* Responsive stacking for controls */
        @media (max-width: 1024px) {
            .main-container { flex-direction: column; align-items: center; }
            #controls-panel { width: 100%; max-width: 600px; margin-bottom: 1.5rem; flex-direction: row; flex-wrap: wrap; justify-content: center; }
            /* Adjust control section width when stacked */
            .control-section { width: 45%; min-width: 200px; }
            /* Ensure scale section takes more space when stacked */
             #scale-controls { width: 90%; max-width: 450px; }
        }
         @media (max-width: 480px) {
             /* Stack all control sections fully on small screens */
             .control-section { width: 90%; }
             #scale-controls { max-width: none; } /* Allow scale section full width */
         }

        /* Title */
        .main-title { font-family: var(--title-font); font-size: 2.2rem; color: var(--title-color); text-shadow: var(--title-shadow); margin-bottom: 1rem; text-align: center; width: 100%; }
        @media (max-width: 640px) { .main-title { font-size: 1.6rem; } }

        /* Controls Panel (Side Panel) */
        #controls-panel { display: flex; flex-direction: column; gap: 1rem; width: 240px; flex-shrink: 0; }
        .control-section { background-color: var(--controls-bg); padding: 15px; border-radius: 15px; border: 2px solid var(--controls-border); box-shadow: var(--controls-shadow); display: flex; flex-direction: column; gap: 8px; }
        .control-section h3 { font-family: var(--controls-title-font); color: var(--controls-title-color); text-shadow: var(--controls-title-shadow); font-size: 1.2rem; text-align: center; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* Selectors (within panel) */
        .selector-container label { font-weight: 600; color: var(--label-color); font-size: 0.9rem; text-shadow: var(--label-shadow); display: block; text-align: center; margin-bottom: 3px; }
        .selector-container select { font-weight: 600; background-color: var(--select-bg); color: var(--select-text); border: 1px solid var(--select-border); border-radius: 5px; padding: 5px 8px; width: 90%; cursor: pointer; text-align: center; appearance: none; background-image: url('data:image/svg+xml;utf8,<svg fill="{--select-arrow-fill}" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); background-repeat: no-repeat; background-position: right 8px center; background-size: 18px; margin: 0 auto; display: block; }
        .selector-container select:focus { outline: none; box-shadow: var(--select-focus-shadow); }

        /* Buttons (Scale) */
        .control-button { font-weight: 600; background: var(--button-bg); color: var(--button-text); border: 1px solid var(--button-border); padding: 6px 10px; font-size: 0.85rem; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .control-button:hover { transform: scale(1.05); box-shadow: var(--button-hover-shadow); }
        .control-button.active { background: var(--button-active-bg); color: var(--button-active-text); border-color: var(--button-active-border); box-shadow: var(--button-active-shadow); }
        .control-button.clear { background: var(--clear-button-bg); color: var(--clear-button-text); border-color: var(--clear-button-border); margin-top: 5px; }
        .control-button.clear:hover { box-shadow: var(--clear-button-hover-shadow); }

        /* Play Button Icon */
        .play-button { background-color: var(--play-button-bg); border: 1px solid var(--play-button-border); padding: 3px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; width: 26px; height: 26px; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .play-button:hover { background-color: var(--play-button-hover-bg); }
        .play-button svg { width: 16px; height: 16px; fill: var(--play-button-icon-color); transition: fill 0.2s ease; margin-left: 1px; }
        .play-button:hover svg { fill: var(--play-button-icon-hover-color); }

        
        .neck-area { display: flex; flex-direction: column; align-items: center; flex-grow: 1; width: 100%; }
        .guitar-neck-container { background-color: var(--neck-container-bg); padding: 20px 25px; border-radius: 15px; border: 3px solid var(--neck-container-border); box-shadow: var(--neck-container-shadow); max-width: 100%; overflow-x: auto; width: fit-content; margin: 0 auto; }
        .guitar-neck { display: flex; flex-direction: column; gap: 10px; min-width: 650px; }
        .string { display: flex; align-items: center; height: 25px; position: relative; }
        .string::before { content: ''; position: absolute; left: 25px; right: 0; top: 50%; height: 3px; background-color: var(--string-color); box-shadow: var(--string-shadow); transform: translateY(-50%); z-index: 0; border-radius: 1px; transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        .string[data-string-index="5"]::before { background-color: var(--string-lowE-color); box-shadow: var(--string-lowE-shadow); height: 4px; }
        .string[data-string-index="4"]::before { background-color: var(--string-A-color); box-shadow: var(--string-A-shadow); height: 4px; }
        .string[data-string-index="3"]::before { background-color: var(--string-D-color); box-shadow: var(--string-D-shadow); height: 3.5px; }
        /* Fret Marker */
        .fret-marker { width: 45px; height: 35px; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; z-index: 1; border-radius: 50%; margin: 0 6px; transition: all 0.15s ease; }
        .fret-marker:hover { transform: scale(1.1); }
        .fret-marker:active { transform: scale(0.95); }
        .fret-marker.open-string { width: 35px; height: 35px; margin-right: 20px; margin-left: 0; border: 3px var(--open-marker-border-style) var(--open-marker-border); background-color: var(--open-marker-bg); }
        .fret-marker.open-string:hover { background-color: var(--open-marker-hover-bg); border-style: solid; }
        .fret-marker.fretted:hover { background-color: rgba(51, 255, 51, 0.3); }
        /* Fret lines */
        .fret-marker.fretted::after { content: ''; position: absolute; right: -9px; top: -12px; bottom: -12px; width: 5px; background: var(--fret-line-bg); z-index: 0; border-radius: 3px; box-shadow: var(--fret-line-shadow); transform: var(--fret-line-skew); transition: background 0.3s ease, box-shadow 0.3s ease; }
        .fret-marker[data-fret="12"]::after { display: none; }
        .fret-marker[data-fret="0"]::after { content: ''; position: absolute; right: -15px; top: -12px; bottom: -12px; width: 8px; background: var(--nut-bg); box-shadow: var(--nut-shadow); z-index: 0; border-radius: 4px; transform: var(--fret-line-skew); transition: background 0.3s ease, box-shadow 0.3s ease; }
        /* Fret dots */
        .fret-dot { position: absolute; width: 12px; height: 12px; background-color: var(--fret-dot-bg); border: 1px solid var(--fret-dot-border); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 0; box-shadow: var(--fret-dot-shadow); transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        .fret-dot.double { background-color: var(--fret-dot-double-bg); box-shadow: var(--fret-dot-double-shadow); transform: translate(-50%, -100%); margin-top: -4px; }
        .fret-dot.double + .fret-dot.double { transform: translate(-50%, 0%); margin-top: 4px; }
        /* Fret Numbers */
        #fret-numbers { display: flex; padding-left: 65px; margin-top: 8px; width: 100%; min-width: 650px; }
        .fret-number { width: 57px; text-align: center; font-family: var(--fret-number-font); color: var(--fret-number-color); font-size: 0.9rem; text-shadow: var(--fret-number-shadow); transition: color 0.3s ease, text-shadow 0.3s ease; }

        /* Neck Bottom Controls (Theme, Root Note) */
        #neck-bottom-controls {
            display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: center;
            gap: 1rem; margin-top: 1.5rem; width: 100%; max-width: 500px;
        }
        #neck-bottom-controls .control-section { width: auto; min-width: 180px; padding: 10px 15px; }
        #neck-bottom-controls .selector-container select { width: 130px; }

        /* Note Display (Below Neck) */
        #note-display {
            margin-top: 1.5rem; padding: 15px 20px; background-color: var(--note-display-bg); border-radius: 10px; border: 2px solid var(--note-display-border); box-shadow: var(--note-display-shadow); text-align: center; font-size: 1.6rem; font-weight: 600; color: var(--note-display-text); text-shadow: var(--note-display-text-shadow); min-height: 65px; display: flex; justify-content: center; align-items: center; width: 100%; max-width: 400px; transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease;
        }
        @media (max-width: 640px) { #note-display { font-size: 1.4rem; } }

        /* Highlights */
        .fret-marker.clicked { background-color: var(--clicked-marker-bg); border: 2px solid var(--clicked-marker-border); box-shadow: var(--clicked-marker-shadow); transform: scale(1.1); z-index: 4; }
        .fret-marker.scale-note { box-shadow: var(--scale-highlight-shadow); z-index: 2; }
        .fret-marker.clicked.scale-note { background-color: var(--clicked-marker-bg); box-shadow: var(--scale-highlight-shadow), var(--clicked-marker-shadow); }

        /* Footer - Updated for Clock */
        .footer {
            margin-top: 2rem; font-size: 1rem; color: var(--footer-color); text-shadow: var(--footer-shadow); text-align: center; transition: color 0.3s ease, text-shadow 0.3s ease;
            display: flex; justify-content: center; align-items: center; gap: 15px; width: 100%;
        }
        #digital-clock { font-family: var(--clock-font); font-size: 1.1rem; color: var(--clock-color); text-shadow: var(--clock-shadow); padding: 5px 10px; background-color: rgba(0,0,0,0.2); border-radius: 5px; }
        .footer-text { font-family: var(--footer-font); }
        @media (max-width: 640px) { .footer { font-size: 0.9rem; flex-direction: column; gap: 5px;} #digital-clock { font-size: 1rem; } }

    </style>
</head>
<body class="theme-acoustic">

<h1 class="main-title">Interactive Virtual Guitar Neck</h1>

<div class="main-container">

    
    <div id="controls-panel">
        <div id="sound-controls" class="control-section selector-container">
            <label for="sound-select">Sound</label>
            <select id="sound-select">
                <option value="PolySynth">Default Synth</option>
                <option value="PluckSynth">Pluck Synth</option>
                <option value="FMSynth">FM Synth</option>
                <option value="AMSynth">AM Synth</option>
            </select>
        </div>

        <div id="scale-controls" class="control-section">
            <h3>
                <span id="scale-title">Scales</span>
                <button class="play-button" id="play-scale-button" title="Play Scale Notes">
                     <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                </button>
            </h3>
            <button class="control-button scale-button" data-scale-name="Major">Major</button>
            <button class="control-button scale-button" data-scale-name="Natural Minor">Nat Minor</button>
            <button class="control-button scale-button" data-scale-name="Harmonic Minor">Harm Minor</button>
            <button class="control-button scale-button" data-scale-name="Major Pentatonic">Maj Pent</button>
            <button class="control-button scale-button" data-scale-name="Minor Pentatonic">Min Pent</button>
            <button class="control-button scale-button" data-scale-name="Blues">Blues</button>
            <button class="control-button scale-button" data-scale-name="Dorian">Dorian</button>
            <button class="control-button scale-button" data-scale-name="Phrygian">Phrygian</button>
            <button class="control-button scale-button" data-scale-name="Lydian">Lydian</button>
            <button class="control-button scale-button" data-scale-name="Mixolydian">Mixolydian</button>
        </div>

        <div class="control-section">
             <button class="control-button clear" id="clear-button">Clear Highlights</button>
        </div>
    </div>

    
    <div class="neck-area">
        <div class="guitar-neck-container">
            <div id="guitar-neck" class="guitar-neck"></div>
            <div id="fret-numbers"></div>
        </div>

        
        <div id="neck-bottom-controls">
            <div class="control-section selector-container">
                 <label for="theme-select">Theme</label>
                 <select id="theme-select">
                     <option value="theme-psychedelic">Psychedelic</option>
                     <option value="theme-acoustic" selected>Acoustic</option>
                     <option value="theme-modern">Modern</option>
                 </select>
            </div>
            <div class="control-section selector-container">
                 <label for="root-note-select">Root Note</label>
                 <select id="root-note-select"></select>
            </div>
        </div>

        <div id="note-display" class="w-full max-w-md mt-5">Click a fret!</div>
    </div>

</div>

<footer class="footer">
    <span id="digital-clock"></span>
    <span class="footer-text">Created by Max Prebeg</span>
</footer>

<script>
    // --- Tone.js Setup ---
    let synths = {};
    let currentSynth;
    let defaultSynth;
    const reverb = new Tone.Reverb(0.4).toDestination();
    const delay = new Tone.FeedbackDelay("8n", 0.2).toDestination();
    let audioStarted = false;

    // --- Guitar & Music Data ---
    const NUM_STRINGS = 6;
    const NUM_FRETS = 12;
    const STANDARD_TUNING = ['E4', 'B3', 'G3', 'D3', 'A2', 'E2'];
    let currentTuning = [...STANDARD_TUNING];
    const CHROMATIC_SCALE = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const FRET_DOT_POSITIONS = [3, 5, 7, 9, 12];

    // Scale definitions
    const scales = {
        'Major': { name: 'Major', intervals: [0, 2, 4, 5, 7, 9, 11] },
        'Natural Minor': { name: 'Nat Minor', intervals: [0, 2, 3, 5, 7, 8, 10] },
        'Harmonic Minor': { name: 'Harm Minor', intervals: [0, 2, 3, 5, 7, 8, 11] },
        'Major Pentatonic': { name: 'Maj Pent', intervals: [0, 2, 4, 7, 9] },
        'Minor Pentatonic': { name: 'Min Pent', intervals: [0, 3, 5, 7, 10] },
        'Blues': { name: 'Blues', intervals: [0, 3, 5, 6, 7, 10] },
        'Dorian': { name: 'Dorian', intervals: [0, 2, 3, 5, 7, 9, 10] },
        'Phrygian': { name: 'Phrygian', intervals: [0, 1, 3, 5, 7, 8, 10] },
        'Lydian': { name: 'Lydian', intervals: [0, 2, 4, 6, 7, 9, 11] },
        'Mixolydian': { name: 'Mixolydian', intervals: [0, 2, 4, 5, 7, 9, 10] },
    };

    // State Variables
    let currentRootNote = 'C';
    let currentHighlightType = null; // 'scale' or null
    let currentHighlightName = null; // e.g., 'Major'
    let currentHighlightNotes = null; // Array of note names for scales
    let activeControlButton = null;
    let clockInterval = null;

    // --- DOM Elements ---
    const bodyElement = document.body;
    const guitarNeck = document.getElementById('guitar-neck');
    const noteDisplay = document.getElementById('note-display');
    const controlsPanel = document.getElementById('controls-panel'); // Side panel
    const neckBottomControls = document.getElementById('neck-bottom-controls'); // Container below neck
    const rootNoteSelect = document.getElementById('root-note-select');
    const themeSelect = document.getElementById('theme-select');
    const scaleControls = document.getElementById('scale-controls'); // Container for scale buttons
    const scaleTitle = document.getElementById('scale-title');
    const soundSelect = document.getElementById('sound-select');
    const fretNumbersDiv = document.getElementById('fret-numbers');
    const clearButton = document.getElementById('clear-button');
    const playScaleButton = document.getElementById('play-scale-button');
    const digitalClockElement = document.getElementById('digital-clock');
    let fretMarkers = [];
    let fretMarkerMap = {};
    let lastClickedMarker = null;

    // --- Initialization Functions ---

    /** Initializes Tone.js synths */
    function setupSynths() {
        defaultSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.4, release: 0.8 } }).connect(delay).connect(reverb);
        synths['PolySynth'] = defaultSynth;
        synths['PluckSynth'] = null;
        synths['FMSynth'] = null;
        synths['AMSynth'] = null;
        currentSynth = defaultSynth;
    }

    /** Populates the root note dropdown */
    function populateRootNoteSelector() {
        CHROMATIC_SCALE.forEach(note => {
            const option = document.createElement('option');
            option.value = note; option.textContent = note;
            rootNoteSelect.appendChild(option);
        });
        rootNoteSelect.value = currentRootNote;
    }

    /** Updates text on scale buttons based on root note */
    function updateControlsText() {
        scaleTitle.textContent = `${currentRootNote} Scales`;
        scaleControls.querySelectorAll('.scale-button').forEach(button => {
            const scaleName = button.dataset.scaleName;
            if (scales[scaleName]) button.textContent = `${currentRootNote} ${scales[scaleName].name}`;
        });
    }

    /** Creates the fret number display */
    function createFretNumbers() {
        fretNumbersDiv.innerHTML = '';
        const openLabel = document.createElement('div');
        openLabel.classList.add('fret-number'); openLabel.textContent = '0';
        fretNumbersDiv.appendChild(openLabel);
        for (let i = 1; i <= NUM_FRETS; i++) {
            const numDiv = document.createElement('div');
            numDiv.classList.add('fret-number'); numDiv.textContent = i;
            fretNumbersDiv.appendChild(numDiv);
        }
    }

    /** Applies the selected theme and updates dynamic styles */
    function applyTheme(themeName) {
        bodyElement.className = themeName;
        try {
            const arrowFill = getComputedStyle(bodyElement).getPropertyValue('--select-arrow-fill').trim();
            const validFill = arrowFill && arrowFill !== 'none' ? arrowFill : '#000000';
            const encodedFill = encodeURIComponent(validFill);
            let styleTag = document.getElementById('select-arrow-style');
            if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = 'select-arrow-style';
                document.head.appendChild(styleTag);
            }
            // Apply to all relevant select elements
            styleTag.textContent = `.selector-container select { background-image: url('data:image/svg+xml;utf8,<svg fill="${encodedFill}" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); }`;
        } catch (error) {
            console.error("Error applying theme styles:", error);
        }
    }

    /** Updates the digital clock display */
    function updateClock() {
        if (!digitalClockElement) return;
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
        digitalClockElement.textContent = timeString;
    }

    /** Starts the clock interval */
    function startClock() {
        updateClock();
        if (clockInterval) clearInterval(clockInterval);
        clockInterval = setInterval(updateClock, 1000);
    }


    // --- Note Calculation & Highlighting ---

    /** Gets note name and octave for a string/fret */
    function getNoteData(stringIndex, fret) {
        const openNoteWithOctave = currentTuning[stringIndex];
        const openNote = openNoteWithOctave.replace(/\d/g, '');
        const openOctave = parseInt(openNoteWithOctave.replace(/\D/g, ''));
        const openNoteIndex = CHROMATIC_SCALE.indexOf(openNote);
        if (openNoteIndex === -1) return { noteWithOctave: "Err", noteName: "Err" };

        const noteIndex = (openNoteIndex + fret) % 12;
        const octaveOffset = Math.floor((openNoteIndex + fret) / 12);
        const noteName = CHROMATIC_SCALE[noteIndex];
        const octave = openOctave + octaveOffset;
        return { noteWithOctave: noteName + octave, noteName: noteName };
    }

     /** Calculates note names for a given scale */
     function calculateScaleNotes(rootNote, scaleName) {
        const scaleData = scales[scaleName];
        if (!scaleData || !scaleData.intervals) return null;
        const rootIndex = CHROMATIC_SCALE.indexOf(rootNote);
        if (rootIndex === -1) return null;
        return scaleData.intervals.map(interval => CHROMATIC_SCALE[(rootIndex + interval) % 12]);
    }

    /** Updates visual highlights on the fretboard */
    function updateHighlights() {
        fretMarkers.forEach(marker => {
            marker.classList.remove('scale-note');
        });

        if (currentHighlightType === 'scale' && currentHighlightNotes) {
            fretMarkers.forEach(marker => {
                const stringIndex = parseInt(marker.dataset.stringIndex);
                const fret = parseInt(marker.dataset.fret);
                const { noteName } = getNoteData(stringIndex, fret);
                if (currentHighlightNotes.includes(noteName)) {
                    marker.classList.add('scale-note');
                }
            });
        }
    }

    // --- Event Handlers ---

    /** Handles clicking on a fret marker */
    function handleFretClick(event) {
        event.stopPropagation();
        const marker = event.currentTarget;
        if (!audioStarted) {
            Tone.start().then(() => {
                audioStarted = true;
                console.log("Audio Context Started");
                try {
                    if (!synths['PluckSynth']) synths['PluckSynth'] = new Tone.PluckSynth().connect(delay).connect(reverb);
                    if (!synths['FMSynth']) synths['FMSynth'] = new Tone.FMSynth({ harmonicity: 1.5, modulationIndex: 5, oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 1 }, modulation: { type: "square" }, modulationEnvelope: { attack: 0.05, decay: 0.1, sustain: 0.8, release: 0.5 } }).connect(delay).connect(reverb);
                    if (!synths['AMSynth']) synths['AMSynth'] = new Tone.AMSynth({ harmonicity: 2, oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.8, release: 0.5 }, modulation: { type: "square" }, modulationEnvelope: { attack: 0.05, decay: 0.2, sustain: 0.5, release: 0.5 } }).connect(delay).connect(reverb);
                } catch (synthError) { console.error("Error initializing synths:", synthError); }
                currentSynth = synths[soundSelect.value] || defaultSynth;
                playSoundAndDisplay(marker);
            }).catch(e => { console.error("Audio Context Error:", e); noteDisplay.textContent = "Audio Error"; });
        } else {
            playSoundAndDisplay(marker);
        }
    }

     /** Plays sound and updates display for a clicked marker */
     function playSoundAndDisplay(marker) {
        const stringIndex = parseInt(marker.dataset.stringIndex);
        const fret = parseInt(marker.dataset.fret);
        if (isNaN(stringIndex) || isNaN(fret)) return;

        const { noteWithOctave, noteName } = getNoteData(stringIndex, fret);
        noteDisplay.textContent = `Note: ${noteName} (${noteWithOctave})`;

        try {
            if (currentSynth && typeof currentSynth.triggerAttackRelease === 'function') {
                 const velocity = Math.random() * 0.4 + 0.6;
                 currentSynth.triggerAttackRelease(noteWithOctave, '8n', Tone.now(), velocity);
            } else if (defaultSynth) {
                 console.warn("Current synth not ready, using default.");
                 defaultSynth.triggerAttackRelease(noteWithOctave, '8n', Tone.now());
            } else { console.error("No valid synth available to play sound."); }
        } catch (e) { console.error("Sound Playback Error:", e); noteDisplay.textContent = `Sound Error`; }

        if (lastClickedMarker && lastClickedMarker !== marker) lastClickedMarker.classList.remove('clicked');
        marker.classList.add('clicked');
        lastClickedMarker = marker;
    }

    /** Handles selecting a scale button */
    function handleHighlightSelect(event) {
        const button = event.target.closest('.scale-button');
        if (!button) return;

        const scaleName = button.dataset.scaleName;

        if (activeControlButton) activeControlButton.classList.remove('active');

        if (button === activeControlButton) {
            currentHighlightType = null; currentHighlightName = null;
            currentHighlightNotes = null; activeControlButton = null;
        } else {
            currentHighlightType = 'scale'; currentHighlightName = scaleName;
            currentHighlightNotes = calculateScaleNotes(currentRootNote, scaleName);
            button.classList.add('active'); activeControlButton = button;
        }
        updateHighlights();
    }

    /** Handles changing the root note */
    function handleRootNoteChange(event) {
        currentRootNote = event.target.value;
        updateControlsText();
        if (currentHighlightType === 'scale' && currentHighlightName) {
             currentHighlightNotes = calculateScaleNotes(currentRootNote, currentHighlightName);
             updateHighlights();
        }
    }

    /** Handles changing the sound synth */
    function handleSoundChange(event) {
         const selectedSynthType = event.target.value;
         if (audioStarted && synths[selectedSynthType]) {
            currentSynth = synths[selectedSynthType];
            console.log("Switched synth to:", selectedSynthType);
         } else if (!audioStarted) {
             console.log("Sound selection stored:", selectedSynthType);
         } else if (!synths[selectedSynthType]) {
             console.warn(`Synth type ${selectedSynthType} not initialized yet.`);
         }
    }

    /** Handles clicking the clear highlights button */
    function handleClearHighlights() {
        if (activeControlButton) activeControlButton.classList.remove('active');
        currentHighlightType = null; currentHighlightName = null;
        currentHighlightNotes = null; activeControlButton = null;
        updateHighlights();
    }

    /** Handles changing the theme */
    function handleThemeChange(event) {
        applyTheme(event.target.value);
    }

     /** Plays the notes of the currently selected scale */
     function playScale() {
        if (!audioStarted || currentHighlightType !== 'scale' || !currentHighlightNotes) return;

        const notesToPlay = [];
        for (const scaleNoteName of currentHighlightNotes) {
            let lowestNoteOctave = 10; let lowestNoteFull = null;
            for (let s = 0; s < NUM_STRINGS; s++) {
                for (let f = 0; f <= NUM_FRETS; f++) {
                    const noteData = getNoteData(s, f);
                    if (noteData.noteName === scaleNoteName) {
                         const octave = parseInt(noteData.noteWithOctave.slice(-1));
                         if (octave < lowestNoteOctave) { lowestNoteOctave = octave; lowestNoteFull = noteData.noteWithOctave; }
                    }
                }
            }
            if (lowestNoteFull && !notesToPlay.includes(lowestNoteFull)) notesToPlay.push(lowestNoteFull);
        }

        notesToPlay.sort((a, b) => Tone.Frequency(a).toFrequency() - Tone.Frequency(b).toFrequency());

        const now = Tone.now();
        notesToPlay.forEach((note, index) => {
            currentSynth.triggerAttackRelease(note, '8n', now + index * 0.25);
        });
    }

    // --- Neck Creation ---
    /** Creates the guitar neck elements in the DOM */
    function createGuitarNeck() {
        guitarNeck.innerHTML = '';
        fretMarkers = [];
        fretMarkerMap = {};

        for (let i = 0; i < NUM_STRINGS; i++) {
            const stringDiv = document.createElement('div');
            stringDiv.classList.add('string', 'relative');
            stringDiv.setAttribute('data-string-index', i);

            const openStringMarker = document.createElement('div');
            openStringMarker.classList.add('fret-marker', 'open-string');
            openStringMarker.dataset.stringIndex = i; openStringMarker.dataset.fret = 0;
            openStringMarker.addEventListener('click', handleFretClick);
            stringDiv.appendChild(openStringMarker);
            fretMarkers.push(openStringMarker);
            fretMarkerMap[`${i}-0`] = openStringMarker;

            for (let j = 1; j <= NUM_FRETS; j++) {
                const fretMarker = document.createElement('div');
                fretMarker.classList.add('fret-marker', 'fretted');
                fretMarker.dataset.stringIndex = i; fretMarker.dataset.fret = j;

                const centerString1 = Math.floor(NUM_STRINGS / 2) - 1;
                const centerString2 = Math.floor(NUM_STRINGS / 2);
                if (i === centerString1 || i === centerString2) {
                    if (FRET_DOT_POSITIONS.includes(j)) {
                         if (j === 12) {
                            const dot1 = document.createElement('div'); dot1.classList.add('fret-dot', 'double'); fretMarker.appendChild(dot1);
                            const dot2 = document.createElement('div'); dot2.classList.add('fret-dot', 'double'); fretMarker.appendChild(dot2);
                         } else {
                            const dot = document.createElement('div'); dot.classList.add('fret-dot'); fretMarker.appendChild(dot);
                         }
                    }
                }
                fretMarker.addEventListener('click', handleFretClick);
                stringDiv.appendChild(fretMarker);
                fretMarkers.push(fretMarker);
                fretMarkerMap[`${i}-${j}`] = fretMarker;
            }
            guitarNeck.appendChild(stringDiv);
        }
        createFretNumbers();
    }

    // --- Global Initialization ---
    /** Runs when the page is fully loaded */
    document.addEventListener('DOMContentLoaded', () => {
        setupSynths();
        populateRootNoteSelector();
        createGuitarNeck();
        updateControlsText();
        startClock();

        // Set and apply the default theme
        themeSelect.value = 'theme-acoustic';
        applyTheme(themeSelect.value);

        // Setup Event Listeners
        // Side Panel Controls (Scales, Sound, Clear)
        controlsPanel.addEventListener('click', (event) => {
             if (event.target.closest('.scale-button')) handleHighlightSelect(event);
             if (event.target.closest('#play-scale-button')) playScale();
             if (event.target === clearButton) handleClearHighlights();
        });
         controlsPanel.addEventListener('change', (event) => {
             if (event.target === soundSelect) handleSoundChange(event);
         });

         // Neck Bottom Controls (Theme, Root Note) - Use delegation on the new container
         neckBottomControls.addEventListener('change', (event) => {
             if (event.target === themeSelect) handleThemeChange(event);
             if (event.target === rootNoteSelect) handleRootNoteChange(event);
         });

    });

</script>

</body>
</html>
