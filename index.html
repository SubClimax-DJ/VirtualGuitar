<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Guitar Neck V6 - Key Finder</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Monoton&family=Inter:wght@400;600;700&family=Roboto+Slab:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* Default: Psychedelic Theme Variables */
            --bg-gradient: linear-gradient(135deg, #ff00ff, #ff6600, #ffff00, #33ff33, #00ffff, #8a2be2);
            --bg-animation: gradientShift 15s ease infinite;
            --title-font: 'Monoton', cursive;
            --title-color: #ffffff;
            --title-shadow: 2px 2px 4px #000, -2px -2px 4px #f0f, 2px -2px 4px #0ff, -2px 2px 4px #ff0;
            --controls-bg: rgba(138, 43, 226, 0.8); /* Violet */
            --controls-border: #00ffff; /* Cyan */
            --controls-shadow: 0 0 15px 3px rgba(0, 255, 255, 0.5); /* Cyan glow */
            --controls-title-font: 'Monoton', cursive;
            --controls-title-color: #ffff00; /* Yellow */
            --controls-title-shadow: 1px 1px 2px #ff00ff;
            --label-color: #00ffff; /* Cyan */
            --label-shadow: 1px 1px 1px #8a2be2;
            --select-bg: rgba(0,0,0,0.5);
            --select-text: #ffff00; /* Yellow */
            --select-border: #ff00ff; /* Magenta */
            --select-focus-shadow: 0 0 8px #ff00ff;
            --select-arrow-fill: #ffff00;
            --button-bg: linear-gradient(45deg, #ff00ff, #ff6600);
            --button-text: white;
            --button-border: #ffff00;
            --button-hover-shadow: 0 0 10px #ffff00;
            --button-active-bg: linear-gradient(45deg, #33ff33, #00ffff);
            --button-active-text: #1f2937;
            --button-active-border: #ffffff;
            --button-active-shadow: 0 0 10px #00ffff;
            --clear-button-bg: linear-gradient(45deg, #888, #ccc);
            --clear-button-text: #333;
            --clear-button-border: #fff;
            --clear-button-hover-shadow: 0 0 10px #fff;
            --neck-container-bg: #8a2be2; /* Deep Purple */
            --neck-container-border: #ffffff;
            --neck-container-shadow: 0 0 20px 5px rgba(255, 255, 255, 0.5), inset 0 0 10px 2px rgba(0, 0, 0, 0.4);
            --string-color: #00ffff; /* Cyan */
            --string-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff;
            --string-lowE-color: #33ff33; /* Lime */
            --string-lowE-shadow: 0 0 5px #33ff33, 0 0 10px #33ff33;
            --string-A-color: #ffff00; /* Yellow */
            --string-A-shadow: 0 0 5px #ffff00, 0 0 10px #ffff00;
            --string-D-color: #ff6600; /* Orange */
            --string-D-shadow: 0 0 5px #ff6600, 0 0 10px #ff6600;
            --open-marker-border: #ffff00; /* Yellow */
            --open-marker-border-style: dashed;
            --open-marker-bg: rgba(255, 0, 255, 0.2); /* Magenta */
            --open-marker-hover-bg: rgba(255, 0, 255, 0.4);
            --fret-line-bg: linear-gradient(to bottom, #ff00ff, #00ffff);
            --fret-line-shadow: 0 0 3px #ffffff;
            --fret-line-skew: skewX(-5deg);
            --nut-bg: #ffffff;
            --nut-shadow: 0 0 8px #ffffff;
            --fret-dot-bg: #ff6600; /* Orange */
            --fret-dot-border: white;
            --fret-dot-shadow: 0 0 5px #ff6600;
            --fret-dot-double-bg: #33ff33; /* Lime */
            --fret-dot-double-shadow: 0 0 5px #33ff33;
            --fret-number-font: 'Monoton', cursive;
            --fret-number-color: #ffff00;
            --fret-number-shadow: 1px 1px 1px #8a2be2;
            --note-display-bg: rgba(0, 0, 0, 0.6);
            --note-display-border: #ff00ff; /* Magenta */
            --note-display-shadow: 0 0 15px #ff00ff;
            --note-display-text: #33ff33; /* Lime */
            --note-display-text-shadow: 0 0 5px #33ff33;
            --clicked-marker-bg: rgba(0, 255, 255, 0.7); /* Cyan */
            --clicked-marker-border: #ffffff; /* Clicked border color */
            --clicked-marker-shadow: 0 0 10px #00ffff; /* Clicked shadow */
            --highlight-shadow: inset 0 0 0 3px #ffff00, 0 0 5px #ffff00; /* Scale highlight (Yellow) */
            --chord-highlight-shadow: inset 0 0 0 3px #ff00ff, 0 0 5px #ff00ff; /* Chord highlight (Magenta) */
            --root-highlight-border-color: #33ff33; /* Root note border color (Lime Green) */
            --marker-note-color: #ffffff; /* White note text */
            --marker-note-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            --footer-font: 'Monoton', cursive;
            --footer-color: #ffffff;
            --footer-shadow: 1px 1px 2px #000, -1px -1px 2px #8a2be2, 1px -1px 2px #0ff;
            --clock-font: 'Orbitron', sans-serif;
            --clock-color: #ffffff;
            --clock-shadow: var(--footer-shadow);
            --play-button-bg: rgba(255, 255, 255, 0.1);
            --play-button-border: var(--controls-title-color);
            --play-button-hover-bg: rgba(255, 255, 255, 0.2);
            --play-button-icon-color: var(--controls-title-color);
            --play-button-icon-hover-color: var(--label-color);
            --key-finder-collected-color: var(--select-text); /* Use select text color for collected notes */
            --key-finder-suggestion-color: var(--title-color); /* Use title color for suggestions */
        }
        body.theme-acoustic { /* Acoustic Theme Variables */
            --bg-gradient: linear-gradient(to bottom, #a16207, #422006); --bg-animation: none; --title-font: 'Roboto Slab', serif; --title-color: #fef3c7; --title-shadow: 2px 2px 4px rgba(0,0,0,0.6); --controls-bg: rgba(120, 53, 15, 0.8); --controls-border: #fcd34d; --controls-shadow: 0 0 10px 2px rgba(252, 211, 77, 0.4); --controls-title-font: 'Roboto Slab', serif; --controls-title-color: #fef3c7; --controls-title-shadow: 1px 1px 2px rgba(0,0,0,0.5); --label-color: #fcd34d; --label-shadow: 1px 1px 1px rgba(0,0,0,0.4); --select-bg: rgba(66, 32, 6, 0.7); --select-text: #fef3c7; --select-border: #fcd34d; --select-focus-shadow: 0 0 8px #fcd34d; --select-arrow-fill: #fcd34d; --button-bg: linear-gradient(45deg, #d97706, #92400e); --button-text: #ffffff; --button-border: #fef3c7; --button-hover-shadow: 0 0 10px #fcd34d; --button-active-bg: linear-gradient(45deg, #fcd34d, #fbbf24); --button-active-text: #422006; --button-active-border: #ffffff; --button-active-shadow: 0 0 10px #fbbf24;
            --neck-container-bg:
                linear-gradient(to bottom, #b45309, #874006),
                repeating-linear-gradient(90deg,
                    rgba(66, 32, 6, 0) 0, rgba(66, 32, 6, 0) 4px, rgba(66, 32, 6, 0.15) 5px, rgba(66, 32, 6, 0.15) 6px, rgba(66, 32, 6, 0) 7px, rgba(66, 32, 6, 0) 10px, rgba(245, 208, 115, 0.05) 11px, rgba(245, 208, 115, 0.05) 12px, rgba(66, 32, 6, 0) 13px, rgba(66, 32, 6, 0) 20px
                );
            --neck-container-border: #fde68a; --neck-container-shadow: 0 6px 12px rgba(0,0,0,0.4), inset 0 0 8px 1px rgba(0, 0, 0, 0.3); --string-color: #e5e7eb; --string-shadow: none; --string-lowE-color: #d1d5db; --string-lowE-shadow: none; --string-A-color: #d1d5db; --string-A-shadow: none; --string-D-color: #e5e7eb; --string-D-shadow: none; --open-marker-border: #9ca3af; --open-marker-border-style: solid; --open-marker-bg: rgba(255, 255, 255, 0.1); --open-marker-hover-bg: rgba(255, 255, 255, 0.2);
             --fret-line-bg: #a8a29e; /* Grey fret lines */
             --fret-line-shadow: 1px 1px 2px rgba(0,0,0,0.3);
             --fret-line-skew: none; --nut-bg: #e5e7eb; --nut-shadow: none;
            --fret-dot-bg: #fef3c7; /* Use light creamy color like fret numbers */
            --fret-dot-border: #92400e; /* Darker border for contrast */
            --fret-dot-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* Add a slight shadow */
            --fret-dot-double-bg: #fef3c7; /* Same light color */
            --fret-dot-double-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* Same shadow */
            --fret-number-font: 'Roboto Slab', serif; --fret-number-color: #fef3c7; --fret-number-shadow: 1px 1px 1px rgba(0,0,0,0.4); --note-display-bg: rgba(66, 32, 6, 0.85); --note-display-border: #fcd34d; --note-display-shadow: 0 0 10px rgba(252, 211, 77, 0.3); --note-display-text: #fef9c3; --note-display-text-shadow: 1px 1px 2px rgba(0,0,0,0.5); --clicked-marker-bg: rgba(251, 191, 36, 0.6); --clicked-marker-border: #fef3c7; --clicked-marker-shadow: 0 0 8px #fbbf24;
            --highlight-shadow: inset 0 0 0 3px #fcd34d, 0 0 5px #fcd34d; /* Scale highlight (Amber) */
            --chord-highlight-shadow: inset 0 0 0 3px #fb923c, 0 0 5px #fb923c; /* Chord highlight (Orange) */
            --root-highlight-border-color: #854d0e; /* Root note border color (Dark Reddish-Brown) */
            --marker-note-color: #422006; /* Dark brown note text */
            --marker-note-shadow: 1px 1px 1px rgba(255,255,255,0.4);
            --footer-font: 'Roboto Slab', serif; --footer-color: #fef3c7; --footer-shadow: 1px 1px 2px rgba(0,0,0,0.6); --clock-font: 'Orbitron', sans-serif; --clock-color: var(--footer-color); --clock-shadow: var(--footer-shadow); --play-button-bg: rgba(254, 243, 199, 0.15); --play-button-border: #fcd34d; --play-button-hover-bg: rgba(254, 243, 199, 0.25); --play-button-icon-color: #fcd34d; --play-button-icon-hover-color: #fef3c7;
            --key-finder-collected-color: var(--select-text);
            --key-finder-suggestion-color: var(--title-color);
        }
        body.theme-modern { /* Modern Theme Variables */
            --bg-gradient: linear-gradient(to bottom, #1f2937, #374151); --bg-animation: none; --title-font: 'Inter', sans-serif; --title-color: #e5e7eb; --title-shadow: none; --controls-bg: rgba(55, 65, 81, 0.85); --controls-border: #6b7280; --controls-shadow: 0 4px 8px rgba(0,0,0,0.3); --controls-title-font: 'Inter', sans-serif; --controls-title-color: #e5e7eb; --controls-title-shadow: none; --label-color: #d1d5db; --label-shadow: none; --select-bg: rgba(31, 41, 55, 0.8); --select-text: #e5e7eb; --select-border: #4b5563; --select-focus-shadow: 0 0 0 2px #60a5fa; --select-arrow-fill: #9ca3af; --button-bg: linear-gradient(45deg, #3b82f6, #2563eb); --button-text: white; --button-border: #60a5fa; --button-hover-shadow: 0 0 8px rgba(96, 165, 250, 0.5); --button-active-bg: linear-gradient(45deg, #60a5fa, #93c5fd); --button-active-text: #1f2937; --button-active-border: #ffffff; --button-active-shadow: 0 0 8px #93c5fd; --clear-button-bg: linear-gradient(45deg, #6b7280, #9ca3af); --clear-button-text: #1f2937; --clear-button-border: #d1d5db; --clear-button-hover-shadow: 0 0 8px #9ca3af;
             --neck-container-bg:
                linear-gradient(to bottom, #374151, #1f2937),
                repeating-linear-gradient(-45deg, rgba(255, 255, 255, 0.02) 0, rgba(255, 255, 255, 0.02) 1px, transparent 1px, transparent 6px );
            --neck-container-border: #9ca3af; --neck-container-shadow: 0 6px 12px rgba(0,0,0,0.3), inset 0 0 5px rgba(0,0,0,0.2); --string-color: #9ca3af; --string-shadow: none; --string-lowE-color: #6b7280; --string-lowE-shadow: none; --string-A-color: #6b7280; --string-A-shadow: none; --string-D-color: #9ca3af; --string-D-shadow: none; --open-marker-border: #6b7280; --open-marker-border-style: solid; --open-marker-bg: rgba(255, 255, 255, 0.05); --open-marker-hover-bg: rgba(255, 255, 255, 0.1);
            --fret-line-bg: #9ca3af; /* Grey fret lines */
            --fret-line-shadow: none; --fret-line-skew: none; --nut-bg: #d1d5db; --nut-shadow: none; --fret-dot-bg: #d1d5db; --fret-dot-border: #6b7280; --fret-dot-shadow: none; --fret-dot-double-bg: #d1d5db; --fret-dot-double-shadow: none; --fret-number-font: 'Inter', sans-serif; --fret-number-color: #9ca3af; --fret-number-shadow: none; --note-display-bg: rgba(31, 41, 55, 0.9); --note-display-border: #6b7280; --note-display-shadow: 0 4px 8px rgba(0,0,0,0.2); --note-display-text: #93c5fd; --note-display-text-shadow: none; --clicked-marker-bg: rgba(96, 165, 250, 0.7); --clicked-marker-border: #dbeafe; --clicked-marker-shadow: 0 0 8px #60a5fa;
            --highlight-shadow: inset 0 0 0 3px #60a5fa, 0 0 5px #60a5fa; /* Scale highlight (Blue) */
            --chord-highlight-shadow: inset 0 0 0 3px #a78bfa, 0 0 5px #a78bfa; /* Chord highlight (Purple) */
            --root-highlight-border-color: #ffffff; /* Root note border color (White) */
            --marker-note-color: #1f2937; /* Dark gray note text */
            --marker-note-shadow: 1px 1px 1px rgba(255,255,255,0.2);
            --footer-font: 'Inter', sans-serif; --footer-color: #9ca3af; --footer-shadow: none; --clock-font: 'Orbitron', sans-serif; --clock-color: var(--footer-color); --clock-shadow: var(--footer-shadow); --play-button-bg: rgba(219, 234, 254, 0.1); --play-button-border: #60a5fa; --play-button-hover-bg: rgba(219, 234, 254, 0.2); --play-button-icon-color: #60a5fa; --play-button-icon-hover-color: #93c5fd;
            --key-finder-collected-color: var(--select-text);
            --key-finder-suggestion-color: var(--title-color);
        }

        /* --- BASE STYLES --- */
        html, body { height: 100%; margin: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            background-size: 400% 400%;
            animation: var(--bg-animation);
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; padding: 1rem; overflow-x: hidden;
        }
        @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* --- LAYOUT STYLES --- */
        .main-container { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; gap: 1.5rem; width: 100%; max-width: 1400px; margin-top: 1rem; }
        @media (max-width: 1024px) { .main-container { flex-direction: column; align-items: center; } #controls-panel { width: 100%; max-width: 600px; margin-bottom: 1.5rem; flex-direction: row; flex-wrap: wrap; justify-content: center; } .control-section { width: 45%; min-width: 200px; } #scale-controls, #chord-controls { width: 90%; max-width: 450px; } } /* Apply wrap to chords too */
        @media (max-width: 480px) { .control-section { width: 90%; } #scale-controls, #chord-controls { max-width: none; } } /* Apply wrap to chords too */
        .main-title { font-family: var(--title-font); font-size: 2.2rem; color: var(--title-color); text-shadow: var(--title-shadow); margin-bottom: 1rem; text-align: center; width: 100%; }
        @media (max-width: 640px) { .main-title { font-size: 1.6rem; } }
        #controls-panel { display: flex; flex-direction: column; gap: 1rem; width: 240px; flex-shrink: 0; }
        .control-section { background-color: var(--controls-bg); padding: 15px; border-radius: 15px; border: 2px solid var(--controls-border); box-shadow: var(--controls-shadow); display: flex; flex-direction: column; gap: 8px; }
        .control-section h3 { font-family: var(--controls-title-font); color: var(--controls-title-color); text-shadow: var(--controls-title-shadow); font-size: 1.2rem; text-align: center; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .selector-container label { font-weight: 600; color: var(--label-color); font-size: 0.9rem; text-shadow: var(--label-shadow); display: block; text-align: center; margin-bottom: 3px; }
        .selector-container select { font-weight: 600; background-color: var(--select-bg); color: var(--select-text); border: 1px solid var(--select-border); border-radius: 5px; padding: 5px 8px; width: 90%; cursor: pointer; text-align: center; appearance: none; background-repeat: no-repeat; background-position: right 8px center; background-size: 18px; margin: 0 auto; display: block; }
        .selector-container select:focus { /* Let :focus-visible handle outline */ box-shadow: var(--select-focus-shadow); } /* Keep specific shadow */
        .control-button { font-weight: 600; background: var(--button-bg); color: var(--button-text); border: 1px solid var(--button-border); padding: 6px 10px; font-size: 0.85rem; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .control-button:hover { transform: scale(1.05); box-shadow: var(--button-hover-shadow); }
        .control-button.active { background: var(--button-active-bg); color: var(--button-active-text); border-color: var(--button-active-border); box-shadow: var(--button-active-shadow); }
        .control-button.clear { background: var(--clear-button-bg); color: var(--clear-button-text); border-color: var(--clear-button-border); margin-top: 5px; }
        .control-button.clear:hover { box-shadow: var(--clear-button-hover-shadow); }
        /* Key Finder Button Style */
        .control-button.key-finder { /* Inherits base styles */
            margin-top: 5px; /* Add some space */
        }
        .play-button { background-color: var(--play-button-bg); border: 1px solid var(--play-button-border); padding: 3px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; width: 26px; height: 26px; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .play-button:hover { background-color: var(--play-button-hover-bg); }
        .play-button svg { width: 16px; height: 16px; fill: var(--play-button-icon-color); transition: fill 0.2s ease; margin-left: 1px; }
        .play-button:hover svg { fill: var(--play-button-icon-hover-color); }
        .neck-area { display: flex; flex-direction: column; align-items: center; flex-grow: 1; width: 100%; }
        .guitar-neck-container {
            background: var(--neck-container-bg); padding: 20px 25px; border-radius: 15px; border: 3px solid var(--neck-container-border); box-shadow: var(--neck-container-shadow); max-width: 100%; overflow-x: auto; width: fit-content; margin: 0 auto;
            background-blend-mode: overlay;
            transition: box-shadow 0.3s ease; /* Add transition for key finder glow */
        }
        /* Style when key finder is active */
        body.key-finder-active .guitar-neck-container {
             box-shadow: var(--neck-container-shadow), 0 0 25px 8px var(--note-display-border); /* Add glow */
        }
        .guitar-neck { display: flex; flex-direction: column; gap: 10px; min-width: 650px; }
        .string { display: flex; align-items: center; height: 25px; position: relative; }
        .string::before {
            content: ''; position: absolute; left: 25px; right: 0; top: 50%; height: 3px;
            background-color: var(--string-color); box-shadow: var(--string-shadow);
            transform: translateY(-50%); z-index: 0; border-radius: 1px; transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .string[data-string-index="5"]::before { background-color: var(--string-lowE-color); box-shadow: var(--string-lowE-shadow); height: 4px; }
        .string[data-string-index="4"]::before { background-color: var(--string-A-color); box-shadow: var(--string-A-shadow); height: 4px; }
        .string[data-string-index="3"]::before { background-color: var(--string-D-color); box-shadow: var(--string-D-shadow); height: 3.5px; }

        /* --- Fret Marker Base Style --- */
        .fret-marker {
            width: 45px; height: 35px; display: flex; justify-content: center; align-items: center;
            cursor: pointer; position: relative; z-index: 1; border-radius: 50%;
            margin: 0 6px; transition: all 0.15s ease; outline: none;
            overflow: visible; color: var(--marker-note-color);
            font-size: 0.9rem; font-weight: 700; text-shadow: var(--marker-note-shadow);
            line-height: 1; border: 3px solid transparent; box-sizing: border-box; background-color: transparent;
        }
        .fret-marker .note-name {
            opacity: 1; pointer-events: none; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 3; transition: opacity 0.2s ease;
        }
        .fret-marker:hover { transform: scale(1.1); }
        .fret-marker:active { transform: scale(0.95); }

        /* --- Open String Marker --- */
        .fret-marker.open-string {
            width: 35px; height: 35px; margin-right: 20px; margin-left: 0;
            border-style: var(--open-marker-border-style); border-color: var(--open-marker-border);
            background-color: var(--open-marker-bg);
        }
        .fret-marker.open-string:hover { background-color: var(--open-marker-hover-bg); border-style: solid; }

        /* --- Fret Line Style --- */
        .fret-marker.fretted::after {
            content: ''; position: absolute; right: -7.5px; top: -10px; bottom: -10px; width: 3px;
            background: var(--fret-line-bg); box-shadow: var(--fret-line-shadow); z-index: 1;
            border-radius: 2px; transform: var(--fret-line-skew, none);
            transition: background 0.3s ease, box-shadow 0.3s ease; pointer-events: none;
        }
        /* Nut Style */
        .fret-marker[data-fret="0"]::after {
            content: ''; position: absolute; right: -11px; top: -10px; bottom: -10px; width: 6px;
            background: var(--nut-bg); box-shadow: var(--nut-shadow); z-index: 1; border-radius: 3px;
            transform: var(--fret-line-skew, none); transition: background 0.3s ease, box-shadow 0.3s ease;
            pointer-events: none;
        }
         .fret-marker[data-fret="12"]::after { display: none; }

        /* --- Fret Dots --- */
        .fret-dot {
            position: absolute; width: 12px; height: 12px; background-color: var(--fret-dot-bg);
            border: 1px solid var(--fret-dot-border); border-radius: 50%; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 2; box-shadow: var(--fret-dot-shadow);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, opacity 0.2s ease-in-out;
            pointer-events: none; opacity: 1;
        }
        .fret-dot.double { background-color: var(--fret-dot-double-bg); box-shadow: var(--fret-dot-double-shadow); }
        .string:nth-child(3) .fret-dot.double { transform: translate(-50%, -100%); margin-top: -4px; }
        .string:nth-child(4) .fret-dot.double { transform: translate(-50%, 0%); margin-top: 4px; }

        /* --- Fret Numbers & Note Display --- */
        #fret-numbers {
            display: flex; padding-left: 0; margin-top: 8px; width: 100%; min-width: 650px; box-sizing: border-box;
        }
        .fret-number {
            width: 57px; text-align: center; font-family: var(--fret-number-font); color: var(--fret-number-color);
            font-size: 0.9rem; text-shadow: var(--fret-number-shadow); transition: color 0.3s ease, text-shadow 0.3s ease; flex-shrink: 0;
        }
        .fret-number:first-child { width: 55px; }

        #neck-bottom-controls { display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem; width: 100%; max-width: 600px; }
        #neck-bottom-controls .control-section { width: auto; min-width: 150px; padding: 10px 15px; }
        #neck-bottom-controls .selector-container select { width: 120px; }
        #note-display { margin-top: 1.5rem; padding: 15px 20px; background-color: var(--note-display-bg); border-radius: 10px; border: 2px solid var(--note-display-border); box-shadow: var(--note-display-shadow); text-align: center; font-size: 1.6rem; font-weight: 600; color: var(--note-display-text); text-shadow: var(--note-display-text-shadow); min-height: 65px; display: flex; flex-direction: column; /* Allow wrapping */ justify-content: center; align-items: center; width: 100%; max-width: 400px; transition: all 0.3s ease; }
        @media (max-width: 640px) { #note-display { font-size: 1.4rem; } }

        /* Key Finder Display Styles */
        #note-display .key-finder-notes {
            font-size: 0.9em; /* Slightly smaller */
            color: var(--key-finder-collected-color);
            margin-bottom: 0.5rem;
            display: block; /* Ensure it's on its own line */
            word-spacing: 0.5em;
        }
         #note-display .key-finder-suggestions {
            font-size: 0.8em; /* Smaller */
            color: var(--key-finder-suggestion-color);
             display: block; /* Ensure it's on its own line */
        }


        /* --- Fret Marker State Styles (Refactored - No !important) --- */
        .fret-marker.highlight-scale { box-shadow: var(--highlight-shadow); z-index: 2; }
        .fret-marker.highlight-chord { box-shadow: var(--chord-highlight-shadow); z-index: 2; }
        .fret-marker.highlight-root { border-color: var(--root-highlight-border-color, red); z-index: 3; }
        .fret-marker.clicked { background-color: var(--clicked-marker-bg); border-color: var(--clicked-marker-border); box-shadow: var(--clicked-marker-shadow); transform: scale(1.1); z-index: 4; }
        .fret-marker.clicked.highlight-scale {}
        .fret-marker.clicked.highlight-chord {}
        .fret-marker.clicked.highlight-root { border-color: var(--root-highlight-border-color, red); z-index: 5; }
        .fret-marker.highlight-scale.highlight-root,
        .fret-marker.highlight-chord.highlight-root { border-color: var(--root-highlight-border-color, red); z-index: 3; }
        .fret-marker.clicked.highlight-scale.highlight-root,
        .fret-marker.clicked.highlight-chord.highlight-root { border-color: var(--root-highlight-border-color, red); z-index: 5; }

        /* --- Footer & Clock --- */
        .footer { margin-top: 2rem; font-size: 1rem; color: var(--footer-color); text-shadow: var(--footer-shadow); text-align: center; transition: color 0.3s ease, text-shadow 0.3s ease; display: flex; justify-content: center; align-items: center; gap: 15px; width: 100%; }
        #digital-clock { font-family: var(--clock-font); font-size: 1.1rem; color: var(--clock-color); text-shadow: var(--clock-shadow); padding: 5px 10px; background-color: rgba(0,0,0,0.2); border-radius: 5px; }
        .footer-text { font-family: var(--footer-font); }
        @media (max-width: 640px) { .footer { font-size: 0.9rem; flex-direction: column; gap: 5px;} #digital-clock { font-size: 1rem; } }

        /* --- Accessibility & Animations --- */
        *:focus-visible { outline: 3px solid var(--select-focus-shadow, blue); outline-offset: 2px; box-shadow: 0 0 0 4px rgba(0,0,0,0.2); }
        .fret-marker:focus-visible { border-color: var(--root-highlight-border-color, cyan); box-shadow: var(--clicked-marker-shadow); }
        .fret-marker.playing { animation: pulse 0.3s ease-out; }
        @keyframes pulse { 0% { transform: scale(1.1); } 50% { transform: scale(1.18); } 100% { transform: scale(1.1); } }
        @keyframes vibrate { 0% { transform: translateY(-50%); } 25% { transform: translateY(-50%) translateY(-1px); } 50% { transform: translateY(-50%) translateY(1px); } 75% { transform: translateY(-50%) translateY(-1px); } 100% { transform: translateY(-50%); } }
        .string-vibrating::before { animation: vibrate 0.1s linear 2; }
        #select-arrow-style {} /* Placeholder for JS */

    </style>
</head>
<body>
    <h1 class="main-title">Interactive Virtual Guitar Neck</h1>

    <div class="main-container">

        <div id="controls-panel">
            <div id="sound-controls" class="control-section selector-container">
                <label for="sound-select">Sound</label>
                <select id="sound-select">
                    <option value="PolySynth">Default Synth</option>
                    <option value="PluckSynth">Pluck Synth</option>
                    <option value="FMSynth">FM Synth</option>
                    <option value="AMSynth">AM Synth</option>
                </select>
            </div>

            <div id="chord-controls" class="control-section selector-container">
                 <h3><span id="chord-title">Chords</span></h3>
                 <label for="chord-type-select">Chord Type</label>
                 <select id="chord-type-select">
                      <option value="">- Select Chord -</option>
                      </select>
            </div>

            <div id="scale-controls" class="control-section">
                <h3>
                    <span id="scale-title">Scales</span>
                    <button class="play-button" id="play-scale-button" title="Play Scale Notes (Ascending)">
                         <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                    </button>
                </h3>
                <button class="control-button scale-button" data-scale-key="Major">Major</button>
                <button class="control-button scale-button" data-scale-key="Natural Minor">Nat Minor</button>
                <button class="control-button scale-button" data-scale-key="Harmonic Minor">Harm Minor</button>
                <button class="control-button scale-button" data-scale-key="Major Pentatonic">Maj Pent</button>
                <button class="control-button scale-button" data-scale-key="Minor Pentatonic">Min Pent</button>
                <button class="control-button scale-button" data-scale-key="Blues">Blues</button>
                <button class="control-button scale-button" data-scale-key="Dorian">Dorian</button>
                <button class="control-button scale-button" data-scale-key="Phrygian">Phrygian</button>
                <button class="control-button scale-button" data-scale-key="Lydian">Lydian</button>
                <button class="control-button scale-button" data-scale-key="Mixolydian">Mixolydian</button>
            </div>

            <div class="control-section">
                 <button class="control-button key-finder" id="key-finder-button">Find Key</button>
                 <button class="control-button clear" id="clear-button">Clear Highlights</button>
            </div>

            <div id="keyboard-info" class="control-section" style="font-size: 0.8rem; text-align: center; padding: 10px;">
                 <h4 style="font-weight: bold; margin-bottom: 5px;">Keyboard:</h4>
                 <div>Strings: 1-6 (High E to Low E)</div>
                 <div>Frets: QWERTY Row (Q=0... \=12)</div>
            </div>
        </div>

        <div class="neck-area">
            <div class="guitar-neck-container" id="guitar-neck-container">
                <div id="guitar-neck" class="guitar-neck">
                     </div>
                <div id="fret-numbers">
                     </div>
            </div>

            <div id="neck-bottom-controls">
                 <div class="control-section selector-container">
                     <label for="tuning-select">Tuning</label>
                     <select id="tuning-select">
                         </select>
                 </div>
                 <div class="control-section selector-container">
                     <label for="root-note-select">Root Note</label>
                     <select id="root-note-select">
                         </select>
                 </div>
                <div class="control-section selector-container">
                     <label for="theme-select">Theme</label>
                     <select id="theme-select">
                         <option value="theme-psychedelic">Psychedelic</option>
                         <option value="theme-acoustic">Acoustic</option>
                         <option value="theme-modern">Modern</option>
                     </select>
                 </div>
            </div>

            <div id="note-display" class="w-full max-w-md mt-5">Loading...</div>
        </div>

    </div>

    <footer class="footer">
        <span id="digital-clock">--:--:-- --</span>
        <span class="footer-text">Created by Max Prebeg</span>
    </footer>

<script>
(function() { // Start IIFE

    // --- Constants ---
    const NUM_STRINGS = 6;
    const NUM_FRETS = 12;
    const CHROMATIC_SCALE = Object.freeze(['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B']);
    const FRET_DOT_POSITIONS = Object.freeze([3, 5, 7, 9, 12]);
    const DEFAULT_ROOT_NOTE = 'C';
    const DEFAULT_THEME = 'theme-acoustic';
    const DEFAULT_SYNTH_TYPE = 'PolySynth';
    const DEFAULT_TUNING_KEY = 'standard';

    const STRING_VIBRATE_CLASS = 'string-vibrating';
    const STRING_VIBRATE_DURATION = 200;

    const TUNINGS = Object.freeze({
        'standard': { name: 'Standard (EADGBe)', notes: ['E4', 'B3', 'G3', 'D3', 'A2', 'E2'] },
        'drop_d':   { name: 'Drop D (DADGBe)', notes: ['E4', 'B3', 'G3', 'D3', 'A2', 'D2'] },
        'dadgad':   { name: 'DADGAD', notes: ['D4', 'A3', 'G3', 'D3', 'A2', 'D2'] },
        'open_g':   { name: 'Open G (DGDGBd)', notes: ['D4', 'B3', 'G3', 'D3', 'G2', 'D2'] },
        'open_d':   { name: 'Open D (DADF#Ad)', notes: ['D4', 'A3', 'F#3', 'D3', 'A2', 'D2'] },
        'open_e':   { name: 'Open E (EBEG#Be)', notes: ['E4', 'B3', 'G#3', 'E3', 'B2', 'E2'] },
        'fourths':  { name: 'All Fourths (EADGCF)', notes: ['F4', 'C4', 'G3', 'D3', 'A2', 'E2'] },
    });

    const STORAGE_KEYS = Object.freeze({
        THEME: 'virtualGuitarTheme',
        ROOT_NOTE: 'virtualGuitarRootNote',
        SOUND: 'virtualGuitarSound',
        TUNING: 'virtualGuitarTuning'
    });

    const FRET_KEY_MAP = Object.freeze({
        'q': 0, 'w': 1, 'e': 2, 'r': 3, 't': 4, 'y': 5, 'u': 6, 'i': 7, 'o': 8, 'p': 9, '[': 10, ']': 11, '\\': 12,
        'Q': 0, 'W': 1, 'E': 2, 'R': 3, 'T': 4, 'Y': 5, 'U': 6, 'I': 7, 'O': 8, 'P': 9, '{': 10, '}': 11, '|': 12
    });
    const STRING_KEY_MAP = Object.freeze({
        '1': 0, '2': 1, '3': 2, '4': 3, '5': 4, '6': 5
    });

    // --- Scales & Chords Data (Simplified for Key Finding) ---
    // We only need the intervals for key finding
    const SCALE_INTERVALS = {
        'Major': [0, 2, 4, 5, 7, 9, 11],
        'Natural Minor': [0, 2, 3, 5, 7, 8, 10]
        // Add other scale types (Harmonic Minor, Melodic Minor) here if desired for suggestions
    };
    const scales = Object.freeze({ // Keep original for button text etc.
        'Major': { name: 'Major', intervals: SCALE_INTERVALS['Major'] },
        'Natural Minor': { name: 'Nat Minor', intervals: SCALE_INTERVALS['Natural Minor'] },
        'Harmonic Minor': { name: 'Harm Minor', intervals: [0, 2, 3, 5, 7, 8, 11] },
        'Major Pentatonic': { name: 'Maj Pent', intervals: [0, 2, 4, 7, 9] },
        'Minor Pentatonic': { name: 'Min Pent', intervals: [0, 3, 5, 7, 10] },
        'Blues': { name: 'Blues', intervals: [0, 3, 5, 6, 7, 10] },
        'Dorian': { name: 'Dorian', intervals: [0, 2, 3, 5, 7, 9, 10] },
        'Phrygian': { name: 'Phrygian', intervals: [0, 1, 3, 5, 7, 8, 10] },
        'Lydian': { name: 'Lydian', intervals: [0, 2, 4, 6, 7, 9, 11] },
        'Mixolydian': { name: 'Mixolydian', intervals: [0, 2, 4, 5, 7, 9, 10] },
    });
    const chords = Object.freeze({ // Unchanged
        'Major': { name: 'Major', intervals: [0, 4, 7] },
        'Minor': { name: 'Minor', intervals: [0, 3, 7] },
        'Diminished': { name: 'Dim', intervals: [0, 3, 6] },
        'Augmented': { name: 'Aug', intervals: [0, 4, 8] },
        'Dominant 7th': { name: '7', intervals: [0, 4, 7, 10] },
        'Major 7th': { name: 'Maj7', intervals: [0, 4, 7, 11] },
        'Minor 7th': { name: 'm7', intervals: [0, 3, 7, 10] },
        'Minor Major 7th': { name: 'm(Maj7)', intervals: [0, 3, 7, 11] },
        'Half-Diminished 7th': { name: 'm7b5', intervals: [0, 3, 6, 10] },
        'Diminished 7th': { name: 'dim7', intervals: [0, 3, 6, 9] },
    });

    const CSS_CLASSES = Object.freeze({
        FRET_MARKER: 'fret-marker', OPEN_STRING: 'open-string', FRETTED: 'fretted',
        FRET_DOT: 'fret-dot', DOUBLE: 'double', CLICKED: 'clicked',
        HIGHLIGHT_SCALE: 'highlight-scale',
        HIGHLIGHT_CHORD: 'highlight-chord',
        HIGHLIGHT_ROOT: 'highlight-root',
        ACTIVE: 'active', SCALE_BUTTON: 'scale-button',
        CLEAR_BUTTON: 'clear', PLAY_BUTTON: 'play-button', PLAYING: 'playing',
        STRING: 'string',
        NOTE_NAME_SPAN: 'note-name',
        KEY_FINDER_BUTTON: 'key-finder' // Class for the key finder button
    });

    // --- State ---
    const state = {
        audioStarted: false,
        currentTuningKey: DEFAULT_TUNING_KEY,
        currentTuning: [...TUNINGS[DEFAULT_TUNING_KEY].notes],
        currentRootNote: DEFAULT_ROOT_NOTE,
        currentTheme: DEFAULT_THEME,
        currentHighlightType: null,
        currentHighlightKey: null,
        currentHighlightNotes: null,
        activeScaleButton: null,
        lastClickedMarker: null,
        currentSynthType: DEFAULT_SYNTH_TYPE,
        synthsInitialized: false,
        clockIntervalId: null,
        fretMarkers: [],
        fretMarkerMap: {},
        activeChordType: null,
        keyFinderModeActive: false, // NEW: Is key finder mode on?
        collectedNotes: new Set() // NEW: Set to store unique notes entered by user
    };

    // --- Audio Setup ---
    let synths = {};
    let defaultSynth;
    let currentSynth;
    let reverb;
    let delay;

    // --- DOM Elements ---
    const bodyElement = document.body;
    const guitarNeckContainer = document.getElementById('guitar-neck-container');
    const guitarNeck = document.getElementById('guitar-neck');
    const noteDisplay = document.getElementById('note-display');
    const controlsPanel = document.getElementById('controls-panel');
    const neckBottomControls = document.getElementById('neck-bottom-controls');
    const rootNoteSelect = document.getElementById('root-note-select');
    const themeSelect = document.getElementById('theme-select');
    const tuningSelect = document.getElementById('tuning-select');
    const scaleControls = document.getElementById('scale-controls');
    const scaleTitle = document.getElementById('scale-title');
    const soundSelect = document.getElementById('sound-select');
    const fretNumbersDiv = document.getElementById('fret-numbers');
    const clearButton = document.getElementById('clear-button');
    const playScaleButton = document.getElementById('play-scale-button');
    const digitalClockElement = document.getElementById('digital-clock');
    const chordControls = document.getElementById('chord-controls');
    const chordTypeSelect = document.getElementById('chord-type-select');
    const chordTitle = document.getElementById('chord-title');
    const keyFinderButton = document.getElementById('key-finder-button'); // NEW

    // --- Utility Functions ---
    function getNoteData(stringIndex, fret) {
        if (stringIndex < 0 || stringIndex >= NUM_STRINGS || fret < 0 || fret > NUM_FRETS || !state.currentTuning[stringIndex]) return null;
        const openNoteWithOctave = state.currentTuning[stringIndex];
        const openNoteMatch = openNoteWithOctave.match(/([A-G]#?)([0-9]+)/);
        if (!openNoteMatch) return null;
        const openNote = openNoteMatch[1];
        const openOctave = parseInt(openNoteMatch[2], 10);
        const openNoteIndex = CHROMATIC_SCALE.indexOf(openNote);
        if (openNoteIndex === -1) return null;
        const noteIndex = (openNoteIndex + fret) % 12;
        const octaveOffset = Math.floor((openNoteIndex + fret) / 12);
        const noteName = CHROMATIC_SCALE[noteIndex];
        const octave = openOctave + octaveOffset;
        return { noteWithOctave: noteName + octave, noteName: noteName };
    }

    // --- Key Finding Logic ---

    /**
     * Generates the notes for a specific scale type given a root note.
     * @param {string} rootNote - The root note (e.g., 'C', 'F#').
     * @param {number[]} intervals - Array of intervals for the scale type (e.g., [0, 2, 4, 5, 7, 9, 11]).
     * @returns {Set<string>} A Set containing the note names in the scale.
     */
    function getScaleNotes(rootNote, intervals) {
        const rootIndex = CHROMATIC_SCALE.indexOf(rootNote);
        if (rootIndex === -1) return new Set(); // Return empty set if root is invalid
        const notes = new Set();
        intervals.forEach(interval => {
            notes.add(CHROMATIC_SCALE[(rootIndex + interval) % 12]);
        });
        return notes;
    }

    /**
     * Analyzes collected notes and suggests potential keys (Major/Natural Minor).
     * @param {Set<string>} collectedNotesSet - A Set of unique note names entered by the user.
     * @returns {string[]} An array of suggested key names (e.g., ["C Major", "A Minor"]).
     */
    function suggestKeys(collectedNotesSet) {
        if (collectedNotesSet.size === 0) return [];

        let suggestions = [];
        let maxMatchCount = 0;

        // Iterate through all 12 possible root notes
        CHROMATIC_SCALE.forEach(root => {
            // Check Major scale
            const majorScaleNotes = getScaleNotes(root, SCALE_INTERVALS['Major']);
            let majorMatchCount = 0;
            collectedNotesSet.forEach(note => {
                if (majorScaleNotes.has(note)) {
                    majorMatchCount++;
                }
            });

            // Check Natural Minor scale
            const minorScaleNotes = getScaleNotes(root, SCALE_INTERVALS['Natural Minor']);
            let minorMatchCount = 0;
            collectedNotesSet.forEach(note => {
                if (minorScaleNotes.has(note)) {
                    minorMatchCount++;
                }
            });

            // Add suggestions if they match all collected notes (or the best match so far)
            // Prioritize scales that contain *all* the collected notes
            if (majorMatchCount === collectedNotesSet.size) {
                 suggestions.push(`${root} Major`);
                 maxMatchCount = majorMatchCount; // Update max count if perfect match
            } else if (majorMatchCount > maxMatchCount && suggestions.every(s => !s.includes('Major'))) {
                 // If it's a better partial match than previous partials, and no perfect match found yet
                 maxMatchCount = majorMatchCount;
                 suggestions = [`${root} Major (${majorMatchCount}/${collectedNotesSet.size})`]; // Clear previous partials
            } else if (majorMatchCount === maxMatchCount && maxMatchCount > 0 && suggestions.every(s => !s.includes('Major'))) {
                 suggestions.push(`${root} Major (${majorMatchCount}/${collectedNotesSet.size})`); // Add as equally good partial match
            }


            if (minorMatchCount === collectedNotesSet.size) {
                 suggestions.push(`${root} Minor`);
                 maxMatchCount = minorMatchCount; // Update max count if perfect match
            } else if (minorMatchCount > maxMatchCount && suggestions.every(s => !s.includes('Minor'))) {
                 maxMatchCount = minorMatchCount;
                 suggestions = [`${root} Minor (${minorMatchCount}/${collectedNotesSet.size})`];
            } else if (minorMatchCount === maxMatchCount && maxMatchCount > 0 && suggestions.every(s => !s.includes('Minor'))) {
                 suggestions.push(`${root} Minor (${minorMatchCount}/${collectedNotesSet.size})`);
            }
        });

         // If we found perfect matches, filter out any partial matches that might have slipped in
         if (suggestions.some(s => !s.includes('/'))) {
             suggestions = suggestions.filter(s => !s.includes('/'));
         }


        // Sort suggestions alphabetically for consistency
        return suggestions.sort();
    }


    function updateNoteDisplay(text, type = 'info') {
        if (!noteDisplay) return;
        noteDisplay.innerHTML = ''; // Clear previous content
        noteDisplay.textContent = text; // Set simple text
        noteDisplay.className = 'note-display'; // Reset class
    }

    /** Updates the note display area for Key Finder mode */
    function updateKeyFinderDisplay() {
        if (!noteDisplay) return;
        noteDisplay.innerHTML = ''; // Clear previous content

        // Display collected notes
        const notesArray = Array.from(state.collectedNotes).sort(); // Sort for consistency
        const notesSpan = document.createElement('span');
        notesSpan.className = 'key-finder-notes';
        notesSpan.textContent = `Notes: ${notesArray.length > 0 ? notesArray.join(' ') : '(Click notes on neck)'}`;
        noteDisplay.appendChild(notesSpan);

        // Get and display suggestions
        const suggestions = suggestKeys(state.collectedNotes);
        const suggestionsSpan = document.createElement('span');
        suggestionsSpan.className = 'key-finder-suggestions';
        if (notesArray.length > 0) {
            suggestionsSpan.textContent = suggestions.length > 0 ? `Likely Keys: ${suggestions.join(' / ')}` : 'No matching keys found yet.';
        } else {
            suggestionsSpan.textContent = ''; // No suggestions if no notes entered
        }
        noteDisplay.appendChild(suggestionsSpan);

        // Add class for specific styling
        noteDisplay.classList.add('key-finder-display');
    }


    // --- LocalStorage Functions ---
    function saveToLocalStorage(key, value) {
        try { localStorage.setItem(key, JSON.stringify(value)); }
        catch (e) { console.error(`Error saving to localStorage (${key}):`, e); }
    }

    function loadFromLocalStorage(key, defaultValue) {
        try {
            const storedValue = localStorage.getItem(key);
            if (key === STORAGE_KEYS.TUNING && storedValue) {
                const parsedKey = JSON.parse(storedValue);
                if (!TUNINGS[parsedKey]) {
                     console.warn(`Saved tuning key "${parsedKey}" not found, reverting to default.`);
                     return defaultValue;
                }
            }
            return storedValue !== null ? JSON.parse(storedValue) : defaultValue;
        } catch (e) {
            console.error(`Error loading from localStorage (${key}):`, e);
            return defaultValue;
        }
    }

    // --- Audio Functions ---
    function setupDefaultAudio() {
        if (!window.Tone) { console.error("Tone.js not loaded!"); updateNoteDisplay("Audio library error!", 'error'); return; }
        reverb = new Tone.Reverb(0.4).toDestination();
        delay = new Tone.FeedbackDelay("8n", 0.2).connect(reverb);
        defaultSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.4, release: 0.8 }
        }).connect(delay);
        synths[DEFAULT_SYNTH_TYPE] = defaultSynth;
        currentSynth = defaultSynth;
        console.log("Default audio setup complete.");
    }

    function initializeExtraSynths() {
        if (state.synthsInitialized || !window.Tone) return;
        try {
            if (!synths['PluckSynth']) synths['PluckSynth'] = new Tone.PluckSynth().connect(delay);
            if (!synths['FMSynth']) synths['FMSynth'] = new Tone.FMSynth({ harmonicity: 1.5, modulationIndex: 5, oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 1 }, modulation: { type: "square" }, modulationEnvelope: { attack: 0.05, decay: 0.1, sustain: 0.8, release: 0.5 } }).connect(delay);
            if (!synths['AMSynth']) synths['AMSynth'] = new Tone.AMSynth({ harmonicity: 2, oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.8, release: 0.5 }, modulation: { type: "square" }, modulationEnvelope: { attack: 0.05, decay: 0.2, sustain: 0.5, release: 0.5 } }).connect(delay);
            state.synthsInitialized = true;
            console.log("Extra synths initialized.");
            updateCurrentSynth();
        } catch (synthError) { console.error("Error initializing extra synths:", synthError); updateNoteDisplay("Error: Sound init failed", 'error'); }
    }

    function updateCurrentSynth() {
       if (state.audioStarted && state.synthsInitialized) {
            currentSynth = synths[state.currentSynthType] || defaultSynth;
             console.log("Switched synth to:", state.currentSynthType);
       } else {
             console.log("Synth selection stored (will apply on audio start):", state.currentSynthType);
             currentSynth = defaultSynth;
       }
    }

    function playSoundForMarker(stringIndex, fret, markerElement) {
        // Skip sound if in key finder mode
        if (state.keyFinderModeActive) return;

        const noteData = getNoteData(stringIndex, fret);
        if (!noteData) { updateNoteDisplay("Error: Note Calc", 'error'); return; };
        if (!state.audioStarted || !currentSynth) { console.warn("Audio not ready or synth not available."); if (!state.audioStarted) updateNoteDisplay("Click again to start sound", 'info'); return; }

        try {
            const activeSynth = currentSynth;
            if (activeSynth?.triggerAttackRelease) {
                const velocity = Math.random() * 0.4 + 0.6;
                activeSynth.triggerAttackRelease(noteData.noteWithOctave, '8n', Tone.now(), velocity);

                if (markerElement) {
                    markerElement.classList.add(CSS_CLASSES.PLAYING);
                    setTimeout(() => { markerElement.classList.remove(CSS_CLASSES.PLAYING); }, 300);
                }
                const stringElement = markerElement?.closest(`.${CSS_CLASSES.STRING}`);
                if (stringElement) {
                    stringElement.classList.remove(STRING_VIBRATE_CLASS);
                    setTimeout(() => {
                        stringElement.classList.add(STRING_VIBRATE_CLASS);
                        setTimeout(() => { stringElement.classList.remove(STRING_VIBRATE_CLASS); }, STRING_VIBRATE_DURATION);
                    }, 10);
                }
            } else { console.error("Selected synth is invalid or missing triggerAttackRelease method."); updateNoteDisplay("Sound Error", 'error'); }
        } catch (e) { console.error("Sound Playback Error:", e); updateNoteDisplay(`Sound Error`, 'error'); }
    }

    function playScale() {
        // Disable scale playback if in key finder mode
        if (state.keyFinderModeActive) {
            updateNoteDisplay("Exit 'Find Key' mode to play scales.", 'info');
            return;
        }
        if (!state.audioStarted) { updateNoteDisplay("Click a fret first to enable sound!"); return; }
        if (state.currentHighlightType !== 'scale' || !state.currentHighlightNotes) { updateNoteDisplay("Select a scale to play!"); return; }
        if (!currentSynth) { updateNoteDisplay("Sound synth not ready.", 'error'); return; }

        const notesToPlay = [];
        for (const scaleNoteName of state.currentHighlightNotes) {
             let lowestNoteOctave = 10; let lowestNoteFull = null;
             state.fretMarkers.forEach(marker => {
                 const stringIndex = parseInt(marker.dataset.stringIndex, 10);
                 const fret = parseInt(marker.dataset.fret, 10);
                 const noteData = getNoteData(stringIndex, fret);
                 if (noteData?.noteName === scaleNoteName) {
                     const octaveMatch = noteData.noteWithOctave.match(/\d+$/);
                     if (octaveMatch) {
                         const octave = parseInt(octaveMatch[0], 10);
                         if (octave < lowestNoteOctave) { lowestNoteOctave = octave; lowestNoteFull = noteData.noteWithOctave; }
                     }
                 }
             });
             if (lowestNoteFull && !notesToPlay.includes(lowestNoteFull)) notesToPlay.push(lowestNoteFull);
        }
        notesToPlay.sort((a, b) => Tone.Frequency(a).toFrequency() - Tone.Frequency(b).toFrequency());
        if (notesToPlay.length === 0) { updateNoteDisplay("Scale notes not found?", 'error'); return; }

        const now = Tone.now(); const activeSynth = currentSynth;
        try {
            updateNoteDisplay(`Playing ${state.currentRootNote} ${scales[state.currentHighlightKey].name}...`);
            notesToPlay.forEach((note, index) => { activeSynth.triggerAttackRelease(note, '8n', now + index * 0.25); });
            // Restore display after playback (adjust delay as needed)
            setTimeout(() => updateNoteDisplay("Ready!"), notesToPlay.length * 250 + 500);
        } catch (e) { console.error("Error playing scale sequence:", e); updateNoteDisplay("Error playing scale", 'error'); }
    }

    // --- DOM Manipulation and UI Updates ---
    function populateTuningSelector() {
        if (!tuningSelect) return;
        tuningSelect.innerHTML = '';
        for (const key in TUNINGS) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = TUNINGS[key].name;
            tuningSelect.appendChild(option);
        }
        tuningSelect.value = state.currentTuningKey;
    }

    function populateRootNoteSelector() {
        if (!rootNoteSelect) return;
        rootNoteSelect.innerHTML = '';
        CHROMATIC_SCALE.forEach(note => { const option = document.createElement('option'); option.value = note; option.textContent = note; rootNoteSelect.appendChild(option); });
        rootNoteSelect.value = state.currentRootNote;
    }

    function populateChordTypeSelector() {
        if (!chordTypeSelect) return;
        chordTypeSelect.innerHTML = '<option value="">- Select Chord -</option>';
        for (const key in chords) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = chords[key].name;
            chordTypeSelect.appendChild(option);
        }
        chordTypeSelect.value = state.activeChordType || "";
    }

    function updateScaleControlsText() {
        if (!scaleTitle || !scaleControls) return;
        scaleTitle.textContent = `${state.currentRootNote} Scales`;
        scaleControls.querySelectorAll(`.${CSS_CLASSES.SCALE_BUTTON}`).forEach(button => { const scaleKey = button.dataset.scaleKey; if (scales[scaleKey]) button.textContent = scales[scaleKey].name; });
    }

    function updateChordControlsText() {
        if (!chordTitle) return;
        chordTitle.textContent = `${state.currentRootNote} Chords`;
    }

    function createFretNumbers() {
        if (!fretNumbersDiv) return;
        fretNumbersDiv.innerHTML = '';
        const openLabel = document.createElement('div');
        openLabel.classList.add('fret-number');
        openLabel.textContent = '0';
        fretNumbersDiv.appendChild(openLabel);
        for (let i = 1; i <= NUM_FRETS; i++) {
            const numDiv = document.createElement('div');
            numDiv.classList.add('fret-number');
            numDiv.textContent = i;
            fretNumbersDiv.appendChild(numDiv);
        }
    }

    function updateMarkerVisual(marker) {
        if (!marker) return;
        const stringIndex = parseInt(marker.dataset.stringIndex, 10);
        const fret = parseInt(marker.dataset.fret, 10);
        const noteData = getNoteData(stringIndex, fret);

        const noteNameSpan = marker.querySelector(`.${CSS_CLASSES.NOTE_NAME_SPAN}`);
        if (noteNameSpan) {
            noteNameSpan.textContent = noteData ? noteData.noteName : '?';
        }

        const noteDesc = noteData ? `${noteData.noteName} (${noteData.noteWithOctave})` : 'Unknown Note';
        const openNote = state.currentTuning[stringIndex]?.replace(/\d/g, '') || `String ${NUM_STRINGS-stringIndex}`;
        marker.title = `${openNote} String, Fret ${fret}: ${noteDesc}`;
    }

    function updateAllMarkerVisuals() {
         state.fretMarkers.forEach(marker => updateMarkerVisual(marker));
    }

    function createMarkerElement(stringIndex, fret) {
        const marker = document.createElement('div');
        marker.classList.add(CSS_CLASSES.FRET_MARKER);
        marker.dataset.stringIndex = stringIndex;
        marker.dataset.fret = fret;
        marker.tabIndex = 0;

        const noteNameSpan = document.createElement('span');
        noteNameSpan.classList.add(CSS_CLASSES.NOTE_NAME_SPAN);
        marker.appendChild(noteNameSpan);

        if (fret === 0) {
            marker.classList.add(CSS_CLASSES.OPEN_STRING);
        } else {
            marker.classList.add(CSS_CLASSES.FRETTED);
             if (FRET_DOT_POSITIONS.includes(fret)) {
                 if (fret === 12) {
                     if (stringIndex === 2 || stringIndex === 3) {
                         const dot = document.createElement('div'); dot.classList.add(CSS_CLASSES.FRET_DOT, CSS_CLASSES.DOUBLE); marker.appendChild(dot);
                     }
                 } else {
                     if (stringIndex === 2) {
                         const dot = document.createElement('div'); dot.classList.add(CSS_CLASSES.FRET_DOT); marker.appendChild(dot);
                     }
                 }
             }
        }

        updateMarkerVisual(marker);

        marker.addEventListener('click', handleFretClick); // Modified handler checks mode
        marker.addEventListener('keydown', (event) => {
             if (event.key === 'Enter' || event.key === ' ') {
                 event.preventDefault();
                 handleFretClick({ target: marker, currentTarget: marker, stopPropagation: () => {} }); // Simulate click event for keydown
             }
        });
        return marker;
    }

    function createGuitarNeck() {
        if (!guitarNeck) return;
        guitarNeck.innerHTML = '';
        state.fretMarkers = [];
        state.fretMarkerMap = {};

        for (let i = 0; i < NUM_STRINGS; i++) {
            const stringDiv = document.createElement('div');
            stringDiv.classList.add(CSS_CLASSES.STRING, 'relative');
            stringDiv.setAttribute('data-string-index', i);
            for (let j = 0; j <= NUM_FRETS; j++) {
                const marker = createMarkerElement(i, j);
                stringDiv.appendChild(marker);
                state.fretMarkers.push(marker);
                state.fretMarkerMap[`${i}-${j}`] = marker;
            }
            guitarNeck.appendChild(stringDiv);
        }
        createFretNumbers();
        console.log("Guitar neck created.");
    }

    function updateHighlights() {
        // Clear previous highlights first
        state.fretMarkers.forEach(marker => {
            marker.classList.remove(
                CSS_CLASSES.HIGHLIGHT_SCALE,
                CSS_CLASSES.HIGHLIGHT_CHORD,
                CSS_CLASSES.HIGHLIGHT_ROOT,
                CSS_CLASSES.CLICKED
            );
        });

        // Don't apply scale/chord highlights if in key finder mode
        if (!state.keyFinderModeActive && state.currentHighlightType && state.currentHighlightNotes) {
            const highlightClass = state.currentHighlightType === 'scale'
                ? CSS_CLASSES.HIGHLIGHT_SCALE
                : CSS_CLASSES.HIGHLIGHT_CHORD;

            state.fretMarkers.forEach(marker => {
                const stringIndex = parseInt(marker.dataset.stringIndex, 10);
                const fret = parseInt(marker.dataset.fret, 10);
                const noteData = getNoteData(stringIndex, fret);

                if (noteData && state.currentHighlightNotes.includes(noteData.noteName)) {
                    marker.classList.add(highlightClass);
                    if (noteData.noteName === state.currentRootNote) {
                        marker.classList.add(CSS_CLASSES.HIGHLIGHT_ROOT);
                    }
                }
            });
        }

        // Apply clicked style only if NOT in key finder mode
        if (!state.keyFinderModeActive && state.lastClickedMarker) {
             state.lastClickedMarker.classList.add(CSS_CLASSES.CLICKED);
        }

        // Update active state for scale buttons only if NOT in key finder mode
        scaleControls.querySelectorAll(`.${CSS_CLASSES.SCALE_BUTTON}`).forEach(button => {
            button.classList.toggle(CSS_CLASSES.ACTIVE, !state.keyFinderModeActive && button === state.activeScaleButton);
        });
    }

    function highlightClickedMarker(marker) {
       // In normal mode, update last clicked and highlights
       if (!state.keyFinderModeActive) {
           state.lastClickedMarker = marker;
           updateHighlights();
       }
       // In key finder mode, this function does nothing extra besides what handleFretClick does
    }

    function applyTheme(themeName) {
        state.currentTheme = themeName;
        bodyElement.className = themeName;
        try {
            requestAnimationFrame(() => {
                const arrowFill = getComputedStyle(bodyElement).getPropertyValue('--select-arrow-fill').trim();
                const validFill = arrowFill && arrowFill !== 'none' ? arrowFill : '#000000';
                const encodedFill = encodeURIComponent(validFill);
                let styleTag = document.getElementById('select-arrow-style');
                if (!styleTag) { styleTag = document.createElement('style'); styleTag.id = 'select-arrow-style'; document.head.appendChild(styleTag); }
                styleTag.textContent = `.selector-container select { background-image: url('data:image/svg+xml;utf8,<svg fill="${encodedFill}" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); }`;
            });
        } catch (error) { console.error("Error applying theme styles (select arrow):", error); }
        saveToLocalStorage(STORAGE_KEYS.THEME, themeName);
        console.log("Theme applied:", themeName);
    }

    function updateClock() {
        if (!digitalClockElement) return;
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
        digitalClockElement.textContent = timeString;
    }

    function startClock() {
        updateClock();
        if (state.clockIntervalId) clearInterval(state.clockIntervalId);
        state.clockIntervalId = setInterval(updateClock, 1000);
    }

    // --- Core Interaction Logic ---
    async function triggerMarkerInteraction(marker) {
        // This function is now primarily for NORMAL mode interaction
        // Key Finder mode logic is handled directly in handleFretClick
        if (!marker || state.keyFinderModeActive) return; // Exit if in key finder mode

        const stringIndex = parseInt(marker.dataset.stringIndex, 10);
        const fret = parseInt(marker.dataset.fret, 10);
        if (isNaN(stringIndex) || isNaN(fret)) { console.error("Invalid marker data:", marker.dataset); return; }

        // Start audio if needed
        if (!state.audioStarted) {
            try {
                updateNoteDisplay("Starting audio..."); await Tone.start(); state.audioStarted = true;
                console.log("Audio Context Started."); updateNoteDisplay("Audio ready!", 'success'); initializeExtraSynths();
            } catch (e) { console.error("Audio Context Error:", e); updateNoteDisplay("Audio Error! Click again?", 'error'); return; }
        }

        // Get note data and play sound
        const noteData = getNoteData(stringIndex, fret);
        if (noteData) {
            updateNoteDisplay(`Note: ${noteData.noteName} (${noteData.noteWithOctave})`);
            playSoundForMarker(stringIndex, fret, marker); // Plays sound
        } else {
            updateNoteDisplay("Error: Note Calc", 'error');
        }

        highlightClickedMarker(marker); // Updates state and highlights
    }

    // --- Event Handlers ---

    /** Handles clicks on fret markers, considering Key Finder mode */
    function handleFretClick(event) {
        event.stopPropagation();
        const marker = event.currentTarget;
        if (!marker) return;

        const stringIndex = parseInt(marker.dataset.stringIndex, 10);
        const fret = parseInt(marker.dataset.fret, 10);
        if (isNaN(stringIndex) || isNaN(fret)) return;

        const noteData = getNoteData(stringIndex, fret);
        if (!noteData) return;

        if (state.keyFinderModeActive) {
            // --- Key Finder Mode Logic ---
            state.collectedNotes.add(noteData.noteName); // Add unique note name
            updateKeyFinderDisplay(); // Update display with collected notes and suggestions
            // Optionally add visual feedback for collected note
            marker.classList.add(CSS_CLASSES.CLICKED); // Briefly highlight clicked
            setTimeout(() => marker.classList.remove(CSS_CLASSES.CLICKED), 200);

        } else {
            // --- Normal Mode Logic ---
            triggerMarkerInteraction(marker); // Handle sound, display, highlight
        }
    }


    function handleScaleSelect(event) {
        // Disable scale selection if in key finder mode
        if (state.keyFinderModeActive) {
            updateKeyFinderDisplay(); // Remind user they are in key finder mode
            return;
        }

        const button = event.target.closest(`.${CSS_CLASSES.SCALE_BUTTON}`);
        if (!button) return;
        const scaleKey = button.dataset.scaleKey;

        state.activeChordType = null;
        if (chordTypeSelect) chordTypeSelect.value = "";

        const isCurrentlyActive = button === state.activeScaleButton;

        if (isCurrentlyActive) {
            state.currentHighlightType = null; state.currentHighlightKey = null; state.currentHighlightNotes = null; state.activeScaleButton = null;
            updateNoteDisplay("Scale deselected.");
        } else {
            state.currentHighlightType = 'scale'; state.currentHighlightKey = scaleKey; state.currentHighlightNotes = calculateScaleNotes(state.currentRootNote, scaleKey); state.activeScaleButton = button;
            updateNoteDisplay(`${state.currentRootNote} ${scales[scaleKey].name} scale selected.`);
        }
        updateHighlights();
    }

    function handleChordSelect(event) {
         // Disable chord selection if in key finder mode
        if (state.keyFinderModeActive) {
            updateKeyFinderDisplay();
            event.target.value = ""; // Reset dropdown
            return;
        }

        const chordKey = event.target.value;
        state.activeChordType = chordKey;
        state.activeScaleButton = null;

        if (chordKey) {
            state.currentHighlightType = 'chord'; state.currentHighlightKey = chordKey; state.currentHighlightNotes = calculateChordNotes(state.currentRootNote, chordKey);
            const chordName = chords[chordKey]?.name || chordKey;
            updateNoteDisplay(`${state.currentRootNote}${chordName} chord selected.`);
        } else {
            state.currentHighlightType = null; state.currentHighlightKey = null; state.currentHighlightNotes = null;
            updateNoteDisplay("Chord deselected.");
        }
        updateHighlights();
    }

    function handleRootNoteChange(event) {
        state.currentRootNote = event.target.value;
        updateScaleControlsText();
        updateChordControlsText();

        // Recalculate based on current mode (scale/chord or key finder suggestions)
        if (state.keyFinderModeActive) {
            updateKeyFinderDisplay(); // Re-run suggestions with same notes but potentially different root context (though suggestKeys doesn't use root currently)
        } else if (state.currentHighlightType === 'scale' && state.currentHighlightKey) {
            state.currentHighlightNotes = calculateScaleNotes(state.currentRootNote, state.currentHighlightKey);
            updateHighlights();
        } else if (state.currentHighlightType === 'chord' && state.currentHighlightKey) {
            state.currentHighlightNotes = calculateChordNotes(state.currentRootNote, state.currentHighlightKey);
            updateHighlights();
        }
        saveToLocalStorage(STORAGE_KEYS.ROOT_NOTE, state.currentRootNote);
    }

    function handleTuningChange(event) {
        const newTuningKey = event.target.value;
        if (!TUNINGS[newTuningKey]) return;

        state.currentTuningKey = newTuningKey;
        state.currentTuning = [...TUNINGS[newTuningKey].notes];

        console.log("Tuning changed to:", TUNINGS[newTuningKey].name);
        updateAllMarkerVisuals(); // Update note names on frets

        // Recalculate based on current mode
        if (state.keyFinderModeActive) {
             updateKeyFinderDisplay(); // Re-run suggestions
        } else if (state.currentHighlightType === 'scale' && state.currentHighlightKey) {
            state.currentHighlightNotes = calculateScaleNotes(state.currentRootNote, state.currentHighlightKey);
            updateHighlights();
        } else if (state.currentHighlightType === 'chord' && state.currentHighlightKey) {
            state.currentHighlightNotes = calculateChordNotes(state.currentRootNote, state.currentHighlightKey);
            updateHighlights();
        }
        saveToLocalStorage(STORAGE_KEYS.TUNING, newTuningKey);
    }


    function handleSoundChange(event) { state.currentSynthType = event.target.value; updateCurrentSynth(); saveToLocalStorage(STORAGE_KEYS.SOUND, state.currentSynthType); }

    /** Exits key finder mode */
    function exitKeyFinderMode() {
        if (!state.keyFinderModeActive) return; // Only run if active

        state.keyFinderModeActive = false;
        state.collectedNotes.clear(); // Clear collected notes
        bodyElement.classList.remove('key-finder-active'); // Remove body class
        if(keyFinderButton) keyFinderButton.classList.remove(CSS_CLASSES.ACTIVE); // Deactivate button
        updateNoteDisplay("Ready!"); // Reset display
        updateHighlights(); // Restore normal highlights
        console.log("Exited Key Finder mode.");
    }

    /** Toggles Key Finder mode on/off */
    function handleKeyFinderToggle() {
        if (state.keyFinderModeActive) {
            exitKeyFinderMode();
        } else {
            // Enter Key Finder Mode
            state.keyFinderModeActive = true;
            state.collectedNotes.clear(); // Start fresh
            // Clear existing highlights/selections
            state.activeScaleButton = null;
            state.activeChordType = null;
            state.currentHighlightType = null;
            state.currentHighlightKey = null;
            state.currentHighlightNotes = null;
            state.lastClickedMarker = null;
            if (chordTypeSelect) chordTypeSelect.value = "";

            bodyElement.classList.add('key-finder-active'); // Add body class for styling neck glow etc.
            if(keyFinderButton) keyFinderButton.classList.add(CSS_CLASSES.ACTIVE); // Activate button
            updateHighlights(); // Clear visual highlights
            updateKeyFinderDisplay(); // Show initial key finder display
            console.log("Entered Key Finder mode.");
        }
    }

    function handleClearHighlights() {
        // Also exit key finder mode if active
        if (state.keyFinderModeActive) {
            exitKeyFinderMode();
        } else {
            // Normal clear logic
            state.activeScaleButton = null;
            state.activeChordType = null;
            state.currentHighlightType = null;
            state.currentHighlightKey = null;
            state.currentHighlightNotes = null;
            state.lastClickedMarker = null;
            if (chordTypeSelect) chordTypeSelect.value = "";
            updateHighlights();
            updateNoteDisplay("Highlights cleared.");
        }
    }

    function handleThemeChange(event) { applyTheme(event.target.value); }

    function handleKeyDown(event) {
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT' || event.target.tagName === 'TEXTAREA') return;
        const stringIndex = STRING_KEY_MAP[event.key]; const fret = FRET_KEY_MAP[event.key];
        if (typeof stringIndex === 'number' && typeof fret === 'number') { console.warn("Ambiguous key press:", event.key); }
        else if (typeof stringIndex === 'number') { const marker = state.fretMarkerMap[`${stringIndex}-0`]; if(marker) { event.preventDefault(); handleFretClick({target: marker, currentTarget: marker, stopPropagation: ()=>{}}); marker.focus(); } } // Use handleFretClick
        else if (typeof fret === 'number') { const targetStringIndex = 0; const marker = state.fretMarkerMap[`${targetStringIndex}-${fret}`]; if(marker) { event.preventDefault(); handleFretClick({target: marker, currentTarget: marker, stopPropagation: ()=>{}}); marker.focus(); } } // Use handleFretClick
    }

    // --- Initialization ---
    function loadSettings() {
        state.currentTheme = loadFromLocalStorage(STORAGE_KEYS.THEME, DEFAULT_THEME);
        state.currentRootNote = loadFromLocalStorage(STORAGE_KEYS.ROOT_NOTE, DEFAULT_ROOT_NOTE);
        state.currentSynthType = loadFromLocalStorage(STORAGE_KEYS.SOUND, DEFAULT_SYNTH_TYPE);
        state.currentTuningKey = loadFromLocalStorage(STORAGE_KEYS.TUNING, DEFAULT_TUNING_KEY);
        state.currentTuning = [...(TUNINGS[state.currentTuningKey]?.notes || TUNINGS[DEFAULT_TUNING_KEY].notes)];

        console.log("Settings loaded:", {
            theme: state.currentTheme,
            root: state.currentRootNote,
            sound: state.currentSynthType,
            tuning: state.currentTuningKey
        });
    }

    function applySettings() {
        if (themeSelect) themeSelect.value = state.currentTheme;
        if (rootNoteSelect) rootNoteSelect.value = state.currentRootNote;
        if (soundSelect) soundSelect.value = state.currentSynthType;
        if (tuningSelect) tuningSelect.value = state.currentTuningKey;

        applyTheme(state.currentTheme);
        updateCurrentSynth();
        updateScaleControlsText();
        updateChordControlsText();
    }

    function initializeApp() {
        console.log("Initializing Virtual Guitar with Key Finder..."); updateNoteDisplay("Initializing...");

        if (!guitarNeck || !controlsPanel || !neckBottomControls || !noteDisplay || !tuningSelect || !keyFinderButton) {
             console.error("Essential DOM elements not found. Aborting initialization.");
             updateNoteDisplay("Initialization Error: Missing Elements!");
             return;
        }

        loadSettings();
        setupDefaultAudio();
        populateTuningSelector();
        populateRootNoteSelector();
        populateChordTypeSelector();
        createGuitarNeck();
        startClock();
        applySettings();

        // --- Setup Event Listeners ---
        if (controlsPanel) {
            controlsPanel.addEventListener('click', (event) => {
                 if (event.target.closest(`.${CSS_CLASSES.SCALE_BUTTON}`)) {
                    const button = event.target.closest(`.${CSS_CLASSES.SCALE_BUTTON}`);
                    handleScaleSelect({ target: button });
                }
                else if (event.target.closest(`#play-scale-button`)) playScale();
                else if (event.target.id === 'clear-button') handleClearHighlights();
                else if (event.target.id === 'key-finder-button') handleKeyFinderToggle(); // Listener for key finder
            });
            controlsPanel.addEventListener('change', (event) => {
                 if (event.target === soundSelect) handleSoundChange(event);
                 else if (event.target === chordTypeSelect) handleChordSelect(event);
            });
        }
        if (neckBottomControls) {
            neckBottomControls.addEventListener('change', (event) => {
                if (event.target === themeSelect) handleThemeChange(event);
                else if (event.target === rootNoteSelect) handleRootNoteChange(event);
                else if (event.target === tuningSelect) handleTuningChange(event);
            });
        }
        document.addEventListener('keydown', handleKeyDown);

        updateHighlights(); // Final highlight update

        updateNoteDisplay("Ready! Click a fret or use keyboard (1-6, Q-\\).");
        console.log("Virtual Guitar Initialized with Key Finder.");
    }

    document.addEventListener('DOMContentLoaded', initializeApp);

})(); // End IIFE
</script>

</body>
</html>
